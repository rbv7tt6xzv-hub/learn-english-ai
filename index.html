<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Tutor AI ‚Äî Curso Completo (Duro-Humano)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#101b33; --line:#22304f;
      --text:#e5e7eb; --muted:#94a3b8; --green:#22c55e; --red:#ef4444; --yellow:#fbbf24;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:linear-gradient(180deg,#070c16,#0b1220 35%,#070c16);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:rgba(15,23,42,.65); border:1px solid var(--line);
      padding:14px 14px; border-radius:18px; position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:15px}
    .brand small{color:var(--muted)}
    .pill{
      display:flex;gap:10px;align-items:center; flex-wrap:wrap; justify-content:flex-end;
      font-size:12px; color:var(--muted);
    }
    .pill span{
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(16,27,51,.6)
    }
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{
      background:rgba(15,23,42,.55);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }
    .h2{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0 0 10px 0}
    .h2 h2{font-size:14px;margin:0;color:var(--text)}
    .h2 small{color:var(--muted)}
    .card{
      background:rgba(16,27,51,.7);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }

    /* Tutor AI block */
    .tutorHeader{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .tutorLeft{display:flex;gap:10px;align-items:center}
    .avatar{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(180deg, rgba(34,197,94,.22), rgba(148,163,184,.12));
      border:1px solid rgba(34,197,94,.35);
      display:grid;place-items:center;font-size:18px
    }
    .tutorMeta{display:flex;flex-direction:column;line-height:1.1}
    .tutorMeta b{font-size:13px}
    .tutorMeta small{color:var(--muted);font-size:12px}
    .statusDot{width:8px;height:8px;border-radius:50%}
    .statusRow{display:flex;gap:8px;align-items:center}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:12px 14px;border-radius:14px;font-weight:700;
      background:rgba(148,163,184,.12);color:var(--text);
      border:1px solid var(--line);
    }
    button.primary{background:var(--green);color:#04120a;border-color:rgba(34,197,94,.6)}
    button.danger{background:var(--red);color:#1b0202;border-color:rgba(239,68,68,.6)}
    button.warn{background:var(--yellow);color:#1a1200;border-color:rgba(251,191,36,.7)}
    button:disabled{opacity:.55;cursor:not-allowed}

    /* Chat */
    .chat{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(11,18,32,.55);
      padding:12px;
      height:290px;
      overflow:auto;
    }
    .msg{display:flex;gap:10px;margin:10px 0}
    .msg .bubble{
      max-width:85%;
      padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(16,27,51,.72)
    }
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{
      background:rgba(34,197,94,.15);
      border-color:rgba(34,197,94,.35)
    }
    .msg.ai .bubble{
      background:rgba(148,163,184,.10);
    }
    .bubble .meta{font-size:11px;color:var(--muted);margin-bottom:6px}
    .bubble .text{white-space:pre-wrap}
    .inputRow{display:flex;gap:10px;margin-top:10px}
    .inputRow input{
      flex:1;
      padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(16,27,51,.7);color:var(--text);
      outline:none;
    }
    .helper{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.4}

    /* Exercise */
    .prompt{
      font-size:16px;margin:0 0 10px 0;line-height:1.35
    }
    .tag{font-size:12px;color:var(--muted)}
    .box{
      border:1px dashed rgba(148,163,184,.35);
      border-radius:16px;padding:12px;background:rgba(16,27,51,.35);
      min-height:52px;display:flex;align-items:center;gap:8px;flex-wrap:wrap
    }
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(16,27,51,.7);cursor:pointer;font-weight:700
    }
    .chip:active{transform:scale(.98)}
    .note{
      font-size:12px;color:var(--muted);margin-top:10px
    }
    .result{
      margin-top:12px;border:1px solid var(--line);border-radius:16px;
      padding:12px;background:rgba(16,27,51,.55)
    }
    .ok{color:#a7f3d0}
    .bad{color:#fecaca}
    .muted{color:var(--muted)}
    .tiny{font-size:11px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <b>English Tutor AI ‚Äî Curso Completo (Duro-Humano)</b>
        <small>Escribe + habla + corrige. Tutor AI visible en pantalla.</small>
      </div>
      <div class="pill">
        <span id="modePill">Modo: Mixto (Local + IA opcional)</span>
        <span id="micPill">üéôÔ∏è Mic: sin probar</span>
        <span id="netPill">üåê IA: no configurada</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT: Tutor AI -->
      <div class="panel">
        <div class="h2">
          <h2>ü§ñ Tutor AI (Visible)</h2>
          <small>Chat + correcci√≥n + sugerencias</small>
        </div>

        <div class="card">
          <div class="tutorHeader">
            <div class="tutorLeft">
              <div class="avatar">üßë‚Äçüè´</div>
              <div class="tutorMeta">
                <b id="tutorName">Teacher Emma (AI)</b>
                <div class="statusRow">
                  <div class="statusDot" id="statusDot" style="background: var(--muted)"></div>
                  <small id="statusText">Idle</small>
                </div>
              </div>
            </div>

            <div class="btnRow">
              <button id="btnSpeak" class="primary">üé§ Hablar (EN) y evaluar</button>
              <button id="btnStop" class="danger" disabled>‚èπÔ∏è Parar micr√≥fono</button>
              <button id="btnHint" class="warn">üí° Pista</button>
            </div>
          </div>

          <div class="chat" id="chat"></div>

          <div class="inputRow">
            <input id="userInput" placeholder="Escribe en ingl√©s..." autocomplete="off" />
            <button id="btnSend" class="primary">Enviar</button>
          </div>

          <div class="helper">
            Tip: si el mic falla en iPhone, ve a <b>Ajustes ‚Üí Safari ‚Üí Micr√≥fono ‚Üí Permitir</b> y en la p√°gina toca <b>aA ‚Üí Configuraci√≥n del sitio ‚Üí Micr√≥fono ‚Üí Permitir</b>.
          </div>
          <div class="tiny" style="margin-top:8px">
            IA real opcional: si configuras un endpoint, el tutor responde ‚Äúde verdad‚Äù. Si no, usa modo local autom√°tico.
          </div>
        </div>
      </div>

      <!-- RIGHT: Exercise -->
      <div class="panel">
        <div class="h2">
          <h2>üß© Ejercicio r√°pido</h2>
          <small>Word Bank + revisi√≥n</small>
        </div>

        <div class="card">
          <p class="prompt"><span class="tag">Responder escribiendo (EN)</span><br>
            Construye la frase correcta con el Word Bank y luego env√≠ala al Tutor.
          </p>

          <div class="box" id="bank">
            <div class="chip" data-word="I">I</div>
            <div class="chip" data-word="need">need</div>
            <div class="chip" data-word="help.">help.</div>
            <div class="chip" data-word="with">with</div>
            <div class="chip" data-word="English.">English.</div>
            <div class="chip" data-word="please.">please.</div>
          </div>

          <div class="note">Tu frase:</div>
          <div class="box" id="phraseBox"><span class="muted">Toca palabras para armar la oraci√≥n‚Ä¶</span></div>

          <div class="btnRow" style="margin-top:10px;justify-content:flex-start">
            <button id="btnRedo">‚Ü©Ô∏è Rehacer</button>
            <button id="btnToInput">‚û°Ô∏è Pasar al input</button>
            <button id="btnReview" class="primary">‚úÖ Revisar</button>
          </div>

          <div class="result" id="reviewBox" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** =========================
 *  CONFIG (IA real opcional)
 *  =========================
 *  Si quieres IA real (modo 2), crea un endpoint que acepte POST JSON:
 *  { "message": "text", "context": {...} }
 *  y responda JSON:
 *  { "reply": "texto del tutor", "correction": "...", "score": 0-100 }
 *
 *  Luego pega la URL aqu√≠:
 */
const AI_ENDPOINT = ""; // <- ejemplo: "https://tu-app.vercel.app/api/tutor"

/** =========================
 *  Estado global
 *  ========================= */
let recognition = null;
let isRecording = false;

const el = (id) => document.getElementById(id);

const chat = el("chat");
const statusDot = el("statusDot");
const statusText = el("statusText");
const micPill = el("micPill");
const netPill = el("netPill");

function setStatus(type, text){
  // type: idle | listening | thinking | ok | bad
  const map = {
    idle: "var(--muted)",
    listening: "var(--yellow)",
    thinking: "rgba(148,163,184,.9)",
    ok: "var(--green)",
    bad: "var(--red)"
  };
  statusDot.style.background = map[type] || "var(--muted)";
  statusText.textContent = text;
}

function addMsg(role, text){
  const row = document.createElement("div");
  row.className = "msg " + (role === "user" ? "user" : "ai");
  const bubble = document.createElement("div");
  bubble.className = "bubble";
  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = role === "user" ? "You" : "Tutor AI";
  const body = document.createElement("div");
  body.className = "text";
  body.textContent = text;
  bubble.appendChild(meta);
  bubble.appendChild(body);
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;
}

function normalize(s){
  return (s || "")
    .trim()
    .replace(/\s+/g," ")
    .replace(/[‚Äú‚Äù]/g,'"')
    .replace(/[‚Äô]/g,"'");
}

/** =========================
 *  Tutor Local (modo 3)
 *  ========================= */
function localTutorReply(userText){
  const t = normalize(userText);
  const lower = t.toLowerCase();

  // ‚ÄúCorrecciones‚Äù simples (muy √∫tiles para tu demo)
  let correction = null;
  let score = 70;
  let tip = "";

  // Heur√≠sticas b√°sicas
  if (!t) {
    return { reply: "I didn‚Äôt catch that. Type a short sentence like: ‚ÄúI need help.‚Äù", correction: "", score: 0 };
  }

  // Caso objetivo: I need help.
  const target1 = "i need help.";
  const target2 = "i need help";
  if (lower === target1 || lower === target2){
    score = 95;
    tip = "Great! Now level up: ‚ÄúI need help with English.‚Äù";
    return {
      reply: `‚úÖ Correct.\n\nTry this next:\n‚Ä¢ I need help with English.\n‚Ä¢ Can you help me, please?\n\nPronunciation tip: say ‚Äúneed‚Äù like /niÀêd/ (long ee).`,
      correction: "I need help.",
      score
    };
  }

  // Si usa palabras del banco pero desordenadas
  if (lower.includes("need") && lower.includes("help") && !lower.includes("i need")){
    correction = "I need help.";
    score = 55;
    tip = "Put ‚ÄúI‚Äù before ‚Äúneed‚Äù.";
  }

  // Si escribi√≥ ‚ÄúNeed I help‚Äù
  if (lower.includes("need i help")){
    correction = "I need help.";
    score = 45;
    tip = "In English: Subject + verb ‚Üí ‚ÄúI need ‚Ä¶‚Äù";
  }

  // Si pide ayuda con ingl√©s
  if (lower.includes("help with english")){
    score = 92;
    return {
      reply: `‚úÖ Nice sentence.\n\nI‚Äôd say:\n‚Ä¢ ‚ÄúI need help with English.‚Äù\n\nNow answer me:\nüëâ What do you need help with?`,
      correction: "I need help with English.",
      score
    };
  }

  // Respuesta general
  const general = [];
  general.push("Thanks! Here‚Äôs a cleaner version:");
  general.push("‚Ä¢ " + (correction || smartPolish(t)));
  general.push("");
  general.push("Now repeat it slowly once.");

  return {
    reply: general.join("\n"),
    correction: correction || smartPolish(t),
    score
  };
}

function smartPolish(t){
  // Capitaliza primera letra y asegura punto final si parece frase
  let s = normalize(t);
  if (!s) return s;
  s = s[0].toUpperCase() + s.slice(1);
  if (!/[.!?]$/.test(s)) s += ".";
  // Arreglo m√≠nimo ‚Äúi‚Äù ‚Üí ‚ÄúI‚Äù
  s = s.replace(/\bi\b/g, "I");
  return s;
}

/** =========================
 *  IA Real (modo 2) con fallback
 *  ========================= */
async function tutorRespond(userText){
  const useRealAI = !!AI_ENDPOINT;
  netPill.textContent = useRealAI ? "üåê IA: configurada" : "üåê IA: no configurada";

  setStatus("thinking", "Thinking‚Ä¶");
  try{
    if (useRealAI){
      const res = await fetch(AI_ENDPOINT, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          message: userText,
          context: {
            lesson: "Basic sentence building",
            target: "I need help."
          }
        })
      });
      if (!res.ok) throw new Error("Endpoint error");
      const data = await res.json();
      const reply = data.reply || "(No reply)";
      setStatus("ok", "Replied");
      return {
        reply,
        correction: data.correction || "",
        score: typeof data.score === "number" ? data.score : null
      };
    }
  }catch(e){
    // cae a local
  }
  const local = localTutorReply(userText);
  setStatus(local.score >= 80 ? "ok" : "bad", local.score >= 80 ? "Good" : "Needs work");
  return local;
}

/** =========================
 *  Mic (Web Speech API)
 *  ========================= */
function initMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (!SR){
    micPill.textContent = "üéôÔ∏è Mic: no soportado";
    return null;
  }
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;

  r.onstart = () => {
    isRecording = true;
    setStatus("listening", "Listening‚Ä¶");
    micPill.textContent = "üéôÔ∏è Mic: escuchando";
    el("btnSpeak").disabled = true;
    el("btnStop").disabled = false;
  };

  r.onend = () => {
    isRecording = false;
    el("btnSpeak").disabled = false;
    el("btnStop").disabled = true;
    if (statusText.textContent === "Listening‚Ä¶") setStatus("idle", "Idle");
    if (micPill.textContent === "üéôÔ∏è Mic: escuchando") micPill.textContent = "üéôÔ∏è Mic: detenido";
  };

  r.onerror = (ev) => {
    // Safari iOS suele dar aborted/not-allowed
    micPill.textContent = "üéôÔ∏è Mic: error (" + (ev.error || "unknown") + ")";
    setStatus("bad", "Mic error");
  };

  r.onresult = async (event) => {
    const spoken = event.results?.[0]?.[0]?.transcript || "";
    micPill.textContent = "üéôÔ∏è Mic: capturado";
    if (spoken){
      addMsg("user", spoken);
      const ans = await tutorRespond(spoken);
      addMsg("ai", ans.reply + formatFooter(ans));
    }else{
      addMsg("ai", "I didn‚Äôt catch anything. Please try again.");
    }
  };

  micPill.textContent = "üéôÔ∏è Mic: listo";
  return r;
}

function formatFooter(ans){
  const bits = [];
  if (ans.correction) bits.push("Correction: " + ans.correction);
  if (typeof ans.score === "number") bits.push("Score: " + ans.score + "/100");
  return bits.length ? ("\n\n‚Äî\n" + bits.join("\n")) : "";
}

/** =========================
 *  UI handlers
 *  ========================= */
function seedChat(){
  addMsg("ai",
`Hi! I‚Äôm Teacher Emma (AI).
Type a sentence, or tap üé§ to speak.
Today‚Äôs target: ‚ÄúI need help.‚Äù`);
  addMsg("ai", `Try now: ‚ÄúI need help.‚Äù`);
}
seedChat();

el("btnSend").onclick = async () => {
  const t = normalize(el("userInput").value);
  if (!t) return;
  el("userInput").value = "";
  addMsg("user", t);
  const ans = await tutorRespond(t);
  addMsg("ai", ans.reply + formatFooter(ans));
};

el("userInput").addEventListener("keydown", (e) => {
  if (e.key === "Enter") el("btnSend").click();
});

el("btnHint").onclick = () => {
  addMsg("ai", "Hint: Use Subject + Verb ‚Üí ‚ÄúI need ‚Ä¶‚Äù\nTry: ‚ÄúI need help.‚Äù");
};

recognition = initMic();

el("btnSpeak").onclick = () => {
  if (!recognition){
    addMsg("ai", "Your browser doesn‚Äôt support the microphone here. Try typing instead.");
    return;
  }
  try{
    recognition.start();
  }catch(e){
    // a veces start() falla si se llama dos veces r√°pido
    micPill.textContent = "üéôÔ∏è Mic: bloqueado";
  }
};

el("btnStop").onclick = () => {
  try{
    recognition && recognition.stop();
  }catch(e){}
};

/** =========================
 *  Word Bank exercise
 *  ========================= */
const phraseBox = el("phraseBox");
let phraseWords = [];

function renderPhrase(){
  phraseBox.innerHTML = "";
  if (phraseWords.length === 0){
    const span = document.createElement("span");
    span.className = "muted";
    span.textContent = "Toca palabras para armar la oraci√≥n‚Ä¶";
    phraseBox.appendChild(span);
    return;
  }
  phraseWords.forEach((w, idx) => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = w;
    chip.title = "Toca para quitar";
    chip.onclick = () => {
      phraseWords.splice(idx,1);
      renderPhrase();
    };
    phraseBox.appendChild(chip);
  });
}

el("bank").addEventListener("click", (e) => {
  const t = e.target;
  if (!t.classList.contains("chip")) return;
  phraseWords.push(t.dataset.word);
  renderPhrase();
});

el("btnRedo").onclick = () => {
  phraseWords = [];
  el("reviewBox").style.display = "none";
  renderPhrase();
};

el("btnToInput").onclick = () => {
  const sentence = phraseWords.join(" ").replace(/\s+([.?!,])/g, "$1");
  el("userInput").value = sentence;
  el("userInput").focus();
};

el("btnReview").onclick = async () => {
  const sentence = phraseWords.join(" ").replace(/\s+([.?!,])/g, "$1");
  const reviewBox = el("reviewBox");
  reviewBox.style.display = "block";

  if (!sentence.trim()){
    reviewBox.innerHTML = `<div class="bad">‚ùå Arma una frase primero.</div>`;
    return;
  }

  // Revisi√≥n simple + env√≠a al tutor
  const target = "I need help.";
  const polished = smartPolish(sentence);
  const ok = normalize(polished).toLowerCase() === target.toLowerCase();

  reviewBox.innerHTML = ok
    ? `<div class="ok">‚úÖ Correcto: <b>${target}</b></div><div class="muted">Ahora env√≠ala al Tutor AI para subir de nivel.</div>`
    : `<div class="bad">‚ùå Casi. Recomendado: <b>${target}</b></div><div class="muted">Tip: ‚ÄúI‚Äù va antes de ‚Äúneed‚Äù.</div>`;

  // Manda al tutor autom√°ticamente
  addMsg("user", polished);
  const ans = await tutorRespond(polished);
  addMsg("ai", ans.reply + formatFooter(ans));
};

renderPhrase();

// Net pill initial
netPill.textContent = AI_ENDPOINT ? "üåê IA: configurada" : "üåê IA: no configurada";
</script>
</body>
</html>
