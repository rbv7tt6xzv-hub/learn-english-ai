<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Tutor AI ‚Äî Curso Completo</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#101b33; --line:#22304f;
      --text:#e5e7eb; --muted:#94a3b8; --green:#22c55e; --red:#ef4444; --yellow:#fbbf24;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:linear-gradient(180deg,#070c16, #0b1220 35%, #070c16);
      color:var(--text); font-family: system-ui, -apple-system, Arial, sans-serif;
      min-height:100vh;
    }
    .app{
      display:grid; grid-template-columns: 1fr; gap:14px;
      max-width:1100px; margin:0 auto; padding:16px;
    }
    @media (min-width: 920px){
      .app{grid-template-columns: 360px 1fr;}
    }
    .panel{
      background:rgba(15,23,42,.86);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    h1{margin:0; font-size:18px}
    .sub{margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.35}
    .chip{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--line); background:#0b1220; color:#cbd5e1;
      padding:7px 10px; border-radius:999px; font-size:12px;
    }
    .topRow{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; margin-top:10px}
    .statGrid{display:grid; gap:10px; margin-top:12px}
    .stat{
      background:#0b1220; border:1px solid var(--line); border-radius:14px; padding:12px;
      display:flex; justify-content:space-between; align-items:center;
    }
    .k{color:var(--muted); font-size:12px}
    .v{font-weight:900; font-size:16px}
    .bar{height:10px; border-radius:999px; background:#070c16; border:1px solid var(--line); overflow:hidden}
    .fill{height:100%; width:0%; background:var(--green)}
    .small{color:var(--muted); font-size:12px; line-height:1.35}
    .divider{height:1px; background:var(--line); margin:12px 0}

    /* Units list */
    .unit{margin-top:10px; padding:10px; border-radius:14px; border:1px solid var(--line); background:#0b1220}
    .unitTitle{font-weight:900; margin:0; font-size:13px}
    .unitDesc{margin:4px 0 0; color:var(--muted); font-size:12px; line-height:1.35}
    .unitBtnRow{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    button{
      cursor:pointer; border:none; border-radius:14px; padding:12px 12px; font-weight:900; font-size:14px;
    }
    .btn{flex:1; min-width:160px}
    .primary{background:var(--green); color:#05210f}
    .secondary{background:#334155; color:#e2e8f0}
    .warn{background:var(--yellow); color:#1f1300}
    .danger{background:var(--red); color:#fff}
    .tinyBtn{
      padding:8px 10px; border-radius:999px; font-size:12px; font-weight:800;
      background:#111a2e; border:1px solid var(--line); color:#e2e8f0;
    }

    /* Main */
    .header{display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .lessonCard{
      margin-top:12px; background:#0b1220; border:1px solid var(--line);
      border-radius:var(--radius); padding:14px;
    }
    .scene{margin:0; color:var(--muted); font-size:13px; line-height:1.35}
    .prompt{
      margin-top:10px; background:#111a2e; border:1px solid #25385e;
      border-radius:14px; padding:12px;
    }
    .label{color:var(--muted); font-size:12px; margin:0 0 6px}
    .es{margin:0; font-size:18px; font-weight:950}
    .hint{margin:10px 0 0; color:#cbd5e1; font-size:13px; line-height:1.35}
    .grid{display:grid; gap:12px; margin-top:12px}
    @media (min-width: 760px){ .grid{grid-template-columns: 1fr 1fr;} }
    input{
      width:100%; margin-top:8px; background:#0b1220; color:var(--text);
      border:1px solid var(--line); border-radius:14px; padding:12px; font-size:16px;
      outline:none;
    }
    .bank{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .tok{
      padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background:#0b1220; color:#fff; font-weight:900; font-size:13px;
    }
    .tok:disabled{opacity:.5}
    .built{
      margin-top:10px; padding:10px; border-radius:14px;
      border:1px dashed var(--line); min-height:48px; background:rgba(7,12,22,.35);
      color:#cbd5e1;
    }
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .feedback{margin-top:12px; font-weight:950; line-height:1.35}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    .lock{opacity:.7}
    .tutors{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .tutorBtn{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      min-width:210px;
      background:#0b1220; border:1px solid var(--line);
      color:var(--text); border-radius:14px; padding:10px 10px;
    }
    .tutorBtn.active{border-color: rgba(34,197,94,.7); box-shadow: 0 0 0 3px rgba(34,197,94,.15);}
    .tName{font-weight:950; font-size:13px}
    .tRole{color:var(--muted); font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <div class="panel">
      <div class="topRow">
        <div>
          <h1>English Tutor AI üá∫üá∏</h1>
          <p class="sub">Curso completo (210 lecciones). M√©todo duro-humano: piensas ‚Üí respondes ‚Üí te corrijo ‚Üí repites.</p>
        </div>
        <span class="chip" id="modeChip">üî• Duro-humano</span>
      </div>

      <div class="statGrid">
        <div class="stat"><div><div class="k">Lecci√≥n</div><div class="v" id="statLesson">1/210</div></div><span class="chip" id="statUnit">Unidad 1.1</span></div>
        <div class="stat"><div><div class="k">XP</div><div class="v" id="statXP">0</div></div><span class="chip" id="statLevel">Nivel 1</span></div>
        <div class="stat"><div><div class="k">Racha</div><div class="v" id="statStreak">0</div></div><span class="chip">‚úÖ</span></div>
        <div class="stat" style="display:block">
          <div class="k">Progreso</div>
          <div class="bar" style="margin-top:8px"><div class="fill" id="fill"></div></div>
          <div class="small" id="pct" style="margin-top:8px">0%</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="small">
        Consejos iPhone: sube volumen y quita silencio. La voz solo funciona despu√©s de tocar un bot√≥n.
      </div>

      <div class="actions">
        <button class="btn secondary" onclick="jumpToFirstIncomplete()">‚ñ∂Ô∏è Continuar</button>
        <button class="btn secondary" onclick="resetProgress()">üîÅ Reiniciar</button>
        <button class="btn danger" onclick="stopVoice()">üîá Parar voz</button>
      </div>

      <div class="divider"></div>

      <div id="units"></div>
    </div>

    <!-- Main -->
    <div class="panel">
      <div class="header">
        <div>
          <div class="chip" id="lessonMeta">Unidad</div>
          <h2 style="margin:10px 0 0; font-size:18px" id="lessonTitle">Cargando‚Ä¶</h2>
          <p class="small" id="lessonSub" style="margin:6px 0 0">‚Ä¶</p>
        </div>
        <div class="chip" id="nextLockChip">üîí Debes acertar para pasar</div>
      </div>

      <div class="tutors">
        <button class="tutorBtn active" id="t0" onclick="setTutor(0)">
          <div>
            <div class="tName">üë©‚Äçüè´ Ana</div>
            <div class="tRole">Corrige en espa√±ol</div>
          </div>
          <span class="chip">ES‚ÜíEN</span>
        </button>
        <button class="tutorBtn" id="t1" onclick="setTutor(1)">
          <div>
            <div class="tName">üë®‚Äçüè´ Mike</div>
            <div class="tRole">Pronunciaci√≥n USA</div>
          </div>
          <span class="chip">Audio EN</span>
        </button>
        <button class="tutorBtn" id="t2" onclick="setTutor(2)">
          <div>
            <div class="tName">üßë‚Äçüè´ Alex</div>
            <div class="tRole">Ingl√©s natural</div>
          </div>
          <span class="chip">Fluidez</span>
        </button>
      </div>

      <div class="lessonCard">
        <p class="scene" id="scene">‚Ä¶</p>

        <div class="prompt">
          <p class="label">Tutor pregunta (ES):</p>
          <p class="es" id="esText">‚Ä¶</p>
          <p class="hint" id="hint">üí° Pista oculta (toca ‚ÄúPista‚Äù)</p>
        </div>

        <div class="grid">
          <div class="prompt">
            <p class="label">‚úçÔ∏è Responder escribiendo (EN)</p>
            <input id="typed" placeholder="Escribe en ingl√©s‚Ä¶" />
            <div class="small">Regla: primero intenta sin ayuda. Si fallas, usa pista o word bank.</div>
          </div>

          <div class="prompt">
            <p class="label">üß© Armar con palabras (Word Bank)</p>
            <div class="bank" id="bank"></div>
            <div class="built">Tu frase: <span id="builtText" style="font-weight:900"></span></div>
            <div class="actions" style="margin-top:10px">
              <button class="btn secondary" onclick="resetWordBank()">‚Ü©Ô∏è Rehacer</button>
              <button class="btn secondary" onclick="copyBuiltToInput()">‚û°Ô∏è Pasar al input</button>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn warn" onclick="speakQuestion()">üîä Pregunta (ES)</button>
          <button class="btn secondary" onclick="speakAnswer()">üîä Ingl√©s (EN)</button>
          <button class="btn secondary" onclick="showHint()">üí° Pista</button>
        </div>

        <div class="actions">
          <button class="btn primary" onclick="check()">‚úÖ Revisar</button>
          <button class="btn secondary" id="nextBtn" onclick="next()">‚û°Ô∏è Siguiente</button>
        </div>

        <div class="feedback" id="fb"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Curso completo (210)
   ========================= */

const UNITS = [
  { id:"1.1", name:"Unidad 1.1 ‚Äî Entender y pedir ayuda", range:[1,20], desc:"No entiendo, repetir, ayuda, se√±ales." },
  { id:"1.2", name:"Unidad 1.2 ‚Äî Presentarte y conversar", range:[21,40], desc:"Nombre, origen, conversaci√≥n b√°sica." },
  { id:"1.3", name:"Unidad 1.3 ‚Äî Comer, pagar, moverte", range:[41,60], desc:"Restaurante, dinero, direcciones." },
  { id:"2.1", name:"Unidad 2.1 ‚Äî Presente real", range:[61,80], desc:"Estructuras b√°sicas que se usan diario." },
  { id:"2.2", name:"Unidad 2.2 ‚Äî Pasado √∫til", range:[81,100], desc:"Ayer, pas√≥, funcion√≥, no funcion√≥." },
  { id:"2.3", name:"Unidad 2.3 ‚Äî Futuro pr√°ctico", range:[101,120], desc:"Planes, promesas, decisiones." },
  { id:"3.1", name:"Unidad 3.1 ‚Äî Trabajo", range:[121,145], desc:"Horario, acceso, tareas, pedir explicaci√≥n." },
  { id:"3.2", name:"Unidad 3.2 ‚Äî Problemas y soluciones", range:[146,170], desc:"Reembolso, reemplazo, acuerdos, conflictos." },
  { id:"4.1", name:"Unidad 4.1 ‚Äî Respuestas reales", range:[171,190], desc:"Respuestas cortas y naturales." },
  { id:"4.2", name:"Unidad 4.2 ‚Äî Ingl√©s de la vida real", range:[191,210], desc:"Gonna/wanna, frases de uso real." },
];

// Lecciones: id, unit, es, en
const LESSONS = [
  // 1.1 (1-20)
  {id:1, unit:"1.1", es:"No entiendo", en:"I don't understand."},
  {id:2, unit:"1.1", es:"¬øPuede repetir?", en:"Can you repeat?"},
  {id:3, unit:"1.1", es:"M√°s despacio, por favor", en:"More slowly, please."},
  {id:4, unit:"1.1", es:"¬øQu√© significa‚Ä¶?", en:"What does it mean?"},
  {id:5, unit:"1.1", es:"¬øC√≥mo se dice ‚Ä¶ en ingl√©s?", en:"How do you say it in English?"},
  {id:6, unit:"1.1", es:"Necesito ayuda", en:"I need help."},
  {id:7, unit:"1.1", es:"Estoy perdido", en:"I'm lost."},
  {id:8, unit:"1.1", es:"¬øHabla espa√±ol?", en:"Do you speak Spanish?"},
  {id:9, unit:"1.1", es:"No s√©", en:"I don't know."},
  {id:10, unit:"1.1", es:"Un momento, por favor", en:"One moment, please."},
  {id:11, unit:"1.1", es:"Espere un segundo", en:"Wait a second."},
  {id:12, unit:"1.1", es:"No escucho bien", en:"I can't hear well."},
  {id:13, unit:"1.1", es:"No entiendo eso", en:"I don't understand that."},
  {id:14, unit:"1.1", es:"¬øPuede escribirlo?", en:"Can you write it?"},
  {id:15, unit:"1.1", es:"¬øPuede mostrarme?", en:"Can you show me?"},
  {id:16, unit:"1.1", es:"Repita otra vez", en:"Repeat it again."},
  {id:17, unit:"1.1", es:"Est√° bien / Est√° mal", en:"It's okay / It's wrong."},
  {id:18, unit:"1.1", es:"¬øEs correcto?", en:"Is it correct?"},
  {id:19, unit:"1.1", es:"Gracias por la ayuda", en:"Thanks for the help."},
  {id:20, unit:"1.1", es:"Perd√≥n, me equivoqu√©", en:"Sorry, I made a mistake."},

  // 1.2 (21-40)
  {id:21, unit:"1.2", es:"¬øC√≥mo te llamas?", en:"What's your name?"},
  {id:22, unit:"1.2", es:"Me llamo‚Ä¶", en:"My name is‚Ä¶"},
  {id:23, unit:"1.2", es:"¬øDe d√≥nde eres?", en:"Where are you from?"},
  {id:24, unit:"1.2", es:"Soy de‚Ä¶", en:"I'm from‚Ä¶"},
  {id:25, unit:"1.2", es:"Mucho gusto", en:"Nice to meet you."},
  {id:26, unit:"1.2", es:"Igualmente", en:"Nice to meet you too."},
  {id:27, unit:"1.2", es:"¬øCu√°ntos a√±os tienes?", en:"How old are you?"},
  {id:28, unit:"1.2", es:"Tengo 30 a√±os", en:"I'm 30 years old."},
  {id:29, unit:"1.2", es:"¬øD√≥nde vives?", en:"Where do you live?"},
  {id:30, unit:"1.2", es:"Vivo aqu√≠", en:"I live here."},
  {id:31, unit:"1.2", es:"¬øA qu√© te dedicas?", en:"What do you do?"},
  {id:32, unit:"1.2", es:"Trabajo en‚Ä¶", en:"I work in‚Ä¶"},
  {id:33, unit:"1.2", es:"Estoy buscando trabajo", en:"I'm looking for a job."},
  {id:34, unit:"1.2", es:"Soy nuevo aqu√≠", en:"I'm new here."},
  {id:35, unit:"1.2", es:"¬øHace cu√°nto tiempo est√°s aqu√≠?", en:"How long have you been here?"},
  {id:36, unit:"1.2", es:"Hace dos meses", en:"For two months."},
  {id:37, unit:"1.2", es:"¬øTe gusta aqu√≠?", en:"Do you like it here?"},
  {id:38, unit:"1.2", es:"S√≠ / No", en:"Yes / No."},
  {id:39, unit:"1.2", es:"M√°s o menos", en:"More or less."},
  {id:40, unit:"1.2", es:"Nos vemos luego", en:"See you later."},

  // 1.3 (41-60)
  {id:41, unit:"1.3", es:"Quiero esto", en:"I want this."},
  {id:42, unit:"1.3", es:"Necesito eso", en:"I need that."},
  {id:43, unit:"1.3", es:"¬øCu√°nto cuesta?", en:"How much is it?"},
  {id:44, unit:"1.3", es:"Es muy caro", en:"It's very expensive."},
  {id:45, unit:"1.3", es:"Est√° bien / Est√° mal", en:"It's good / It's bad."},
  {id:46, unit:"1.3", es:"No es lo que ped√≠", en:"This is not what I ordered."},
  {id:47, unit:"1.3", es:"¬øD√≥nde est√° el ba√±o?", en:"Where is the bathroom?"},
  {id:48, unit:"1.3", es:"¬øPuedo pagar con tarjeta?", en:"Can I pay with card?"},
  {id:49, unit:"1.3", es:"¬øAceptan efectivo?", en:"Do you accept cash?"},
  {id:50, unit:"1.3", es:"La cuenta, por favor", en:"The check, please."},
  {id:51, unit:"1.3", es:"Tengo hambre", en:"I'm hungry."},
  {id:52, unit:"1.3", es:"Tengo sed", en:"I'm thirsty."},
  {id:53, unit:"1.3", es:"¬øA qu√© hora abre?", en:"What time do you open?"},
  {id:54, unit:"1.3", es:"¬øA qu√© hora cierra?", en:"What time do you close?"},
  {id:55, unit:"1.3", es:"Estoy esperando", en:"I'm waiting."},
  {id:56, unit:"1.3", es:"Es aqu√≠", en:"It's here."},
  {id:57, unit:"1.3", es:"Es all√°", en:"It's over there."},
  {id:58, unit:"1.3", es:"A la derecha / izquierda", en:"To the right / left."},
  {id:59, unit:"1.3", es:"Cerca / lejos", en:"Near / far."},
  {id:60, unit:"1.3", es:"Gracias, ya com√≠", en:"Thanks, I already ate."},

  // 2.1 (61-80)
  {id:61, unit:"2.1", es:"Trabajo aqu√≠", en:"I work here."},
  {id:62, unit:"2.1", es:"Estoy trabajando", en:"I'm working."},
  {id:63, unit:"2.1", es:"No trabajo hoy", en:"I don't work today."},
  {id:64, unit:"2.1", es:"Trabajo ma√±ana", en:"I work tomorrow."},
  {id:65, unit:"2.1", es:"Necesito tiempo", en:"I need time."},
  {id:66, unit:"2.1", es:"Quiero aprender", en:"I want to learn."},
  {id:67, unit:"2.1", es:"Tengo una pregunta", en:"I have a question."},
  {id:68, unit:"2.1", es:"No tengo tiempo", en:"I don't have time."},
  {id:69, unit:"2.1", es:"Puedo hacerlo", en:"I can do it."},
  {id:70, unit:"2.1", es:"No puedo hacerlo", en:"I can't do it."},
  {id:71, unit:"2.1", es:"Tengo un problema", en:"I have a problem."},
  {id:72, unit:"2.1", es:"No tengo problema", en:"I don't have a problem."},
  {id:73, unit:"2.1", es:"Estoy listo", en:"I'm ready."},
  {id:74, unit:"2.1", es:"No estoy listo", en:"I'm not ready."},
  {id:75, unit:"2.1", es:"Estoy ocupado", en:"I'm busy."},
  {id:76, unit:"2.1", es:"Estoy libre", en:"I'm free."},
  {id:77, unit:"2.1", es:"Estoy cansado", en:"I'm tired."},
  {id:78, unit:"2.1", es:"Estoy aprendiendo", en:"I'm learning."},
  {id:79, unit:"2.1", es:"Me gusta", en:"I like it."},
  {id:80, unit:"2.1", es:"No me gusta", en:"I don't like it."},

  // 2.2 (81-100)
  {id:81, unit:"2.2", es:"Ayer", en:"Yesterday."},
  {id:82, unit:"2.2", es:"Ayer trabaj√©", en:"I worked yesterday."},
  {id:83, unit:"2.2", es:"Ayer fui", en:"I went yesterday."},
  {id:84, unit:"2.2", es:"Ayer hice", en:"I did yesterday."},
  {id:85, unit:"2.2", es:"Fue dif√≠cil", en:"It was hard."},
  {id:86, unit:"2.2", es:"Fue f√°cil", en:"It was easy."},
  {id:87, unit:"2.2", es:"No funcion√≥", en:"It didn't work."},
  {id:88, unit:"2.2", es:"Funcion√≥", en:"It worked."},
  {id:89, unit:"2.2", es:"Llegu√© tarde", en:"I arrived late."},
  {id:90, unit:"2.2", es:"Llegu√© temprano", en:"I arrived early."},
  {id:91, unit:"2.2", es:"Perd√≠ mi trabajo", en:"I lost my job."},
  {id:92, unit:"2.2", es:"Encontr√© trabajo", en:"I found a job."},
  {id:93, unit:"2.2", es:"Tuve un problema", en:"I had a problem."},
  {id:94, unit:"2.2", es:"No tuve tiempo", en:"I didn't have time."},
  {id:95, unit:"2.2", es:"Fui al doctor", en:"I went to the doctor."},
  {id:96, unit:"2.2", es:"Me sent√≠ mal", en:"I felt bad."},
  {id:97, unit:"2.2", es:"Me sent√≠ bien", en:"I felt good."},
  {id:98, unit:"2.2", es:"¬øQu√© pas√≥?", en:"What happened?"},
  {id:99, unit:"2.2", es:"Pas√≥ ayer", en:"It happened yesterday."},
  {id:100, unit:"2.2", es:"Todo estuvo bien", en:"Everything was fine."},

  // 2.3 (101-120)
  {id:101, unit:"2.3", es:"Voy a trabajar", en:"I'm going to work."},
  {id:102, unit:"2.3", es:"Voy a estudiar", en:"I'm going to study."},
  {id:103, unit:"2.3", es:"Voy a llamar", en:"I'm going to call."},
  {id:104, unit:"2.3", es:"Voy a regresar", en:"I'm going back."},
  {id:105, unit:"2.3", es:"Voy a intentarlo", en:"I'm going to try."},
  {id:106, unit:"2.3", es:"Ma√±ana trabajo", en:"I work tomorrow."},
  {id:107, unit:"2.3", es:"La pr√≥xima semana", en:"Next week."},
  {id:108, unit:"2.3", es:"M√°s tarde", en:"Later."},
  {id:109, unit:"2.3", es:"Pronto", en:"Soon."},
  {id:110, unit:"2.3", es:"No hoy", en:"Not today."},
  {id:111, unit:"2.3", es:"Tal vez", en:"Maybe."},
  {id:112, unit:"2.3", es:"Creo que s√≠", en:"I think so."},
  {id:113, unit:"2.3", es:"Creo que no", en:"I don't think so."},
  {id:114, unit:"2.3", es:"Veremos", en:"We'll see."},
  {id:115, unit:"2.3", es:"Te llamo luego", en:"I'll call you later."},
  {id:116, unit:"2.3", es:"Te aviso", en:"I'll let you know."},
  {id:117, unit:"2.3", es:"No estoy seguro", en:"I'm not sure."},
  {id:118, unit:"2.3", es:"Estoy seguro", en:"I'm sure."},
  {id:119, unit:"2.3", es:"Espero que s√≠", en:"I hope so."},
  {id:120, unit:"2.3", es:"Nos vemos ma√±ana", en:"See you tomorrow."},

  // 3.1 (121-145)
  {id:121, unit:"3.1", es:"¬øCu√°l es mi horario?", en:"What is my schedule?"},
  {id:122, unit:"3.1", es:"Entro a las 9", en:"I start at 9."},
  {id:123, unit:"3.1", es:"Salgo a las 5", en:"I finish at 5."},
  {id:124, unit:"3.1", es:"Estoy en break", en:"I'm on break."},
  {id:125, unit:"3.1", es:"Ya termin√©", en:"I'm done."},
  {id:126, unit:"3.1", es:"No he terminado", en:"I'm not finished."},
  {id:127, unit:"3.1", es:"Necesito m√°s tiempo", en:"I need more time."},
  {id:128, unit:"3.1", es:"No tengo acceso", en:"I don't have access."},
  {id:129, unit:"3.1", es:"No funciona", en:"It doesn't work."},
  {id:130, unit:"3.1", es:"Hay un problema", en:"There is a problem."},
  {id:131, unit:"3.1", es:"Fue un error", en:"It was a mistake."},
  {id:132, unit:"3.1", es:"Lo arreglo", en:"I'll fix it."},
  {id:133, unit:"3.1", es:"¬øPuede explicarlo otra vez?", en:"Can you explain it again?"},
  {id:134, unit:"3.1", es:"No entend√≠", en:"I didn't understand."},
  {id:135, unit:"3.1", es:"¬øQu√© hago ahora?", en:"What do I do now?"},
  {id:136, unit:"3.1", es:"Estoy aprendiendo", en:"I'm learning."},
  {id:137, unit:"3.1", es:"Soy nuevo", en:"I'm new."},
  {id:138, unit:"3.1", es:"Necesito ayuda", en:"I need help."},
  {id:139, unit:"3.1", es:"¬øEst√° bien as√≠?", en:"Is this okay?"},
  {id:140, unit:"3.1", es:"Est√° listo", en:"It's ready."},
  {id:141, unit:"3.1", es:"Falta esto", en:"This is missing."},
  {id:142, unit:"3.1", es:"Est√° completo", en:"It's complete."},
  {id:143, unit:"3.1", es:"Estoy trabajando en eso", en:"I'm working on it."},
  {id:144, unit:"3.1", es:"Dame un momento", en:"Give me a moment."},
  {id:145, unit:"3.1", es:"Gracias por la paciencia", en:"Thanks for your patience."},

  // 3.2 (146-170)
  {id:146, unit:"3.2", es:"No hay problema", en:"No problem."},
  {id:147, unit:"3.2", es:"S√≠ hay problema", en:"There is a problem."},
  {id:148, unit:"3.2", es:"Necesito arreglar esto", en:"I need to fix this."},
  {id:149, unit:"3.2", es:"No es correcto", en:"It's not correct."},
  {id:150, unit:"3.2", es:"Es correcto", en:"It's correct."},
  {id:151, unit:"3.2", es:"Est√° roto", en:"It's broken."},
  {id:152, unit:"3.2", es:"No est√° listo", en:"It's not ready."},
  {id:153, unit:"3.2", es:"Est√° tarde", en:"It's late."},
  {id:154, unit:"3.2", es:"Est√° temprano", en:"It's early."},
  {id:155, unit:"3.2", es:"Se perdi√≥", en:"It got lost."},
  {id:156, unit:"3.2", es:"Lo encontr√©", en:"I found it."},
  {id:157, unit:"3.2", es:"No es m√≠o", en:"It's not mine."},
  {id:158, unit:"3.2", es:"Es m√≠o", en:"It's mine."},
  {id:159, unit:"3.2", es:"Es tuyo", en:"It's yours."},
  {id:160, unit:"3.2", es:"Est√° vac√≠o", en:"It's empty."},
  {id:161, unit:"3.2", es:"Est√° lleno", en:"It's full."},
  {id:162, unit:"3.2", es:"Necesito reemplazo", en:"I need a replacement."},
  {id:163, unit:"3.2", es:"Necesito un reembolso", en:"I need a refund."},
  {id:164, unit:"3.2", es:"No estoy de acuerdo", en:"I don't agree."},
  {id:165, unit:"3.2", es:"Estoy de acuerdo", en:"I agree."},
  {id:166, unit:"3.2", es:"No es justo", en:"It's not fair."},
  {id:167, unit:"3.2", es:"Es justo", en:"It's fair."},
  {id:168, unit:"3.2", es:"Hablemos", en:"Let's talk."},
  {id:169, unit:"3.2", es:"Vamos a arreglarlo", en:"Let's fix it."},
  {id:170, unit:"3.2", es:"Gracias por entender", en:"Thanks for understanding."},

  // 4.1 (171-190)
  {id:171, unit:"4.1", es:"Claro", en:"Sure."},
  {id:172, unit:"4.1", es:"Tal vez", en:"Maybe."},
  {id:173, unit:"4.1", es:"No realmente", en:"Not really."},
  {id:174, unit:"4.1", es:"Supongo", en:"I guess."},
  {id:175, unit:"4.1", es:"Dame un segundo", en:"Give me a second."},
  {id:176, unit:"4.1", es:"Tiene sentido", en:"That makes sense."},
  {id:177, unit:"4.1", es:"No importa", en:"It doesn't matter."},
  {id:178, unit:"4.1", es:"Est√° bien", en:"That's fine."},
  {id:179, unit:"4.1", es:"Depende", en:"It depends."},
  {id:180, unit:"4.1", es:"As√≠ es", en:"That's right."},
  {id:181, unit:"4.1", es:"Exacto", en:"Exactly."},
  {id:182, unit:"4.1", es:"M√°s o menos", en:"Kind of."},
  {id:183, unit:"4.1", es:"Casi", en:"Almost."},
  {id:184, unit:"4.1", es:"No estoy seguro", en:"I'm not sure."},
  {id:185, unit:"4.1", es:"D√©jame pensar", en:"Let me think."},
  {id:186, unit:"4.1", es:"En serio", en:"Seriously."},
  {id:187, unit:"4.1", es:"Sin problema", en:"No worries."},
  {id:188, unit:"4.1", es:"Est√° bien para m√≠", en:"It's okay with me."},
  {id:189, unit:"4.1", es:"De acuerdo", en:"Alright."},
  {id:190, unit:"4.1", es:"Como quieras", en:"Up to you."},

  // 4.2 (191-210)
  {id:191, unit:"4.2", es:"Voy a ir", en:"I'm gonna go."},
  {id:192, unit:"4.2", es:"Quiero hacer", en:"I wanna do it."},
  {id:193, unit:"4.2", es:"M√°s o menos", en:"Kinda."},
  {id:194, unit:"4.2", es:"Un poco", en:"A little bit."},
  {id:195, unit:"4.2", es:"Ahora mismo", en:"Right now."},
  {id:196, unit:"4.2", es:"En este momento", en:"At the moment."},
  {id:197, unit:"4.2", es:"Estoy ocupado ahora", en:"I'm busy right now."},
  {id:198, unit:"4.2", es:"Te aviso luego", en:"I'll let you know later."},
  {id:199, unit:"4.2", es:"Estoy de camino", en:"I'm on my way."},
  {id:200, unit:"4.2", es:"Ya casi", en:"Almost there."},
  {id:201, unit:"4.2", es:"Dame chance", en:"Give me a chance."},
  {id:202, unit:"4.2", es:"No pasa nada", en:"It's all good."},
  {id:203, unit:"4.2", es:"Me equivoqu√©", en:"I messed up."},
  {id:204, unit:"4.2", es:"Fue mi culpa", en:"It's my fault."},
  {id:205, unit:"4.2", es:"Todo bien", en:"All good."},
  {id:206, unit:"4.2", es:"Estoy bien", en:"I'm good."},
  {id:207, unit:"4.2", es:"No estoy bien", en:"I'm not okay."},
  {id:208, unit:"4.2", es:"Estoy cansado", en:"I'm worn out."},
  {id:209, unit:"4.2", es:"Necesito descanso", en:"I need a break."},
  {id:210, unit:"4.2", es:"Hablamos luego", en:"We'll talk later."},
];

const tutors = [
  {name:"Ana", emoji:"üë©‚Äçüè´", esLang:"es-ES", enLang:"en-US", pitchES:1.05, rateES:0.97, pitchEN:1.05, rateEN:0.92,
   style:"Correcci√≥n clara en espa√±ol: qu√© falt√≥ y c√≥mo se dice natural."},
  {name:"Mike", emoji:"üë®‚Äçüè´", esLang:"es-ES", enLang:"en-US", pitchES:0.98, rateES:0.95, pitchEN:0.92, rateEN:0.92,
   style:"Pronunciaci√≥n USA: escucha y repite."},
  {name:"Alex", emoji:"üßë‚Äçüè´", esLang:"es-ES", enLang:"en-US", pitchES:1.00, rateES:0.98, pitchEN:1.00, rateEN:0.98,
   style:"Fluidez: r√°pido y natural, sin drama."},
];

/* =========================
   Estado y Persistencia
   ========================= */
const KEY = "englishTutorCourse_v1";
let state = loadState() || {
  tutorIndex: 0,
  idx: 0,         // 0..209
  xp: 0,
  streak: 0,
  completed: {},  // lessonId:true
  lastWasCorrect: false,
  hintShown: false,
};

let chosenTokens = [];

function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function loadState(){
  try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; }
}
function resetProgress(){
  stopVoice();
  localStorage.removeItem(KEY);
  state = {tutorIndex:0, idx:0, xp:0, streak:0, completed:{}, lastWasCorrect:false, hintShown:false};
  chosenTokens = [];
  renderUnits();
  renderLesson();
}

/* =========================
   Utilidades
   ========================= */
const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"").toLowerCase().trim().replace(/[‚Äô]/g,"'").replace(/\s+/g," ");
function speak(text, lang, pitch=1.0, rate=1.0){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang; u.pitch = pitch; u.rate = rate;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function stopVoice(){ speechSynthesis.cancel(); }

function tokensFromEnglish(en){
  // separa tokens conservando ? ! . ,
  const cleaned = en.replace(/\s+/g," ").trim();
  const parts = cleaned.split(" ");
  return parts.map(p=>p.trim()).filter(Boolean);
}

function unitForLessonId(id){
  return UNITS.find(u=>id>=u.range[0] && id<=u.range[1])?.id || "‚Äî";
}

function levelFromXP(xp){
  return 1 + Math.floor(xp / 60);
}

function progressPct(){
  const doneCount = Object.keys(state.completed).length;
  return Math.round((doneCount / LESSONS.length) * 100);
}

/* =========================
   UI: Units Sidebar
   ========================= */
function renderUnits(){
  const root = $("units");
  root.innerHTML = "";
  UNITS.forEach(u=>{
    const doneInUnit = LESSONS.filter(L=>L.unit===u.id && state.completed[L.id]).length;
    const totalInUnit = LESSONS.filter(L=>L.unit===u.id).length;

    const box = document.createElement("div");
    box.className = "unit";
    box.innerHTML = `
      <p class="unitTitle">${u.name}</p>
      <p class="unitDesc">${u.desc}</p>
      <div class="small" style="margin-top:6px">Progreso: ${doneInUnit}/${totalInUnit}</div>
      <div class="unitBtnRow">
        <button class="tinyBtn" type="button">Ir a unidad</button>
        <span class="chip">${u.id}</span>
      </div>
    `;
    box.querySelector("button").onclick = ()=>{
      // salta a primera lecci√≥n de esa unidad
      const first = LESSONS.findIndex(L=>L.unit===u.id);
      if(first >= 0){
        state.idx = first;
        state.lastWasCorrect = false;
        state.hintShown = false;
        chosenTokens = [];
        saveState();
        renderLesson();
      }
    };
    root.appendChild(box);
  });
}

function jumpToFirstIncomplete(){
  const firstIncomplete = LESSONS.findIndex(L=>!state.completed[L.id]);
  state.idx = firstIncomplete >= 0 ? firstIncomplete : (LESSONS.length-1);
  state.lastWasCorrect = false;
  state.hintShown = false;
  chosenTokens = [];
  saveState();
  renderLesson();
}

/* =========================
   Tutores
   ========================= */
function setTutor(n){
  state.tutorIndex = n;
  ["t0","t1","t2"].forEach((id,i)=>$(id).classList.toggle("active", i===n));
  saveState();
  renderLesson(); // actualiza estilo y pista
}

/* =========================
   Lecci√≥n (Main)
   ========================= */
function renderLesson(){
  renderUnits();

  const L = LESSONS[state.idx];
  const T = tutors[state.tutorIndex];

  // Sidebar stats
  $("statLesson").innerText = `${L.id}/${LESSONS.length}`;
  $("statUnit").innerText = `Unidad ${L.unit}`;
  $("statXP").innerText = state.xp;
  $("statLevel").innerText = `Nivel ${levelFromXP(state.xp)}`;
  $("statStreak").innerText = state.streak;

  const pct = progressPct();
  $("pct").innerText = `${pct}%`;
  $("fill").style.width = `${pct}%`;

  // Meta main
  $("lessonMeta").innerText = `Unidad ${L.unit} ¬∑ Lecci√≥n ${L.id}`;
  $("lessonTitle").innerText = `${L.es}`;
  $("lessonSub").innerText = `${T.emoji} Tutor ${T.name}: ${T.style}`;
  $("scene").innerText = `Traduce al ingl√©s (vida real). Puedes escribir o armar con palabras.`;

  // ES prompt (no mostramos EN)
  $("esText").innerText = `¬øC√≥mo se dice en ingl√©s?: ‚Äú${L.es}‚Äù`;
  $("hint").innerText = state.hintShown ? buildHint(L) : "üí° Pista oculta (toca ‚ÄúPista‚Äù)";

  // Inputs
  $("typed").value = "";
  chosenTokens = [];
  renderWordBank(L);

  // Feedback
  $("fb").className = "feedback";
  $("fb").innerText = "";

  // Next lock
  const mustBeCorrect = !state.lastWasCorrect;
  $("nextLockChip").innerText = mustBeCorrect ? "üîí Debes acertar para pasar" : "‚úÖ Puedes pasar";
  $("nextBtn").disabled = mustBeCorrect;
  $("nextBtn").classList.toggle("lock", mustBeCorrect);

  // tutor buttons active state
  ["t0","t1","t2"].forEach((id,i)=>$(id).classList.toggle("active", i===state.tutorIndex));
}

function renderWordBank(L){
  const bank = $("bank");
  bank.innerHTML = "";
  const toks = tokensFromEnglish(L.en);
  toks.forEach(tok=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "tok";
    b.innerText = tok;
    b.onclick = ()=>{
      chosenTokens.push(tok);
      $("builtText").innerText = chosenTokens.join(" ");
      b.disabled = true;
    };
    bank.appendChild(b);
  });
  $("builtText").innerText = "";
}

function resetWordBank(){
  chosenTokens = [];
  renderWordBank(LESSONS[state.idx]);
}

function copyBuiltToInput(){
  const built = chosenTokens.join(" ").trim();
  if(built) $("typed").value = built;
}

/* =========================
   Voz / Pistas
   ========================= */
function speakQuestion(){
  const L = LESSONS[state.idx];
  const T = tutors[state.tutorIndex];
  speak(`¬øC√≥mo se dice "${L.es}" en ingl√©s?`, T.esLang, T.pitchES, T.rateES);
}
function speakAnswer(){
  const L = LESSONS[state.idx];
  const T = tutors[state.tutorIndex];
  speak(L.en, T.enLang, T.pitchEN, T.rateEN);
}

function buildHint(L){
  // Pista autom√°tica basada en tokens
  const toks = tokensFromEnglish(L.en);
  const start = toks[0] || "";
  const end = toks[toks.length-1] || "";
  return `üí° Empieza con ‚Äú${start}‚Äù y termina con ‚Äú${end}‚Äù.`;
}

function showHint(){
  state.hintShown = true;
  saveState();
  const L = LESSONS[state.idx];
  $("hint").innerText = buildHint(L);
  const T = tutors[state.tutorIndex];
  speak("Pista. " + buildHint(L).replace("üí°",""), T.esLang, T.pitchES, T.rateES);
}

/* =========================
   Correcci√≥n (Duro-humano)
   ========================= */
function check(){
  const L = LESSONS[state.idx];
  const T = tutors[state.tutorIndex];

  const typed = $("typed").value.trim();
  const built = chosenTokens.join(" ").trim();
  const attempt = typed || built;

  if(!attempt){
    fail("Responde escribiendo o armando la frase con palabras.");
    speak("Responde primero.", T.esLang, T.pitchES, T.rateES);
    return;
  }

  const user = norm(attempt);
  const correct = norm(L.en);

  if(user === correct){
    // Correcto: desbloquea next
    const gain = state.hintShown ? 8 : 12;
    state.xp += gain;
    state.streak += 1;
    state.completed[L.id] = true;
    state.lastWasCorrect = true;
    state.hintShown = false;
    saveState();

    $("fb").className = "feedback ok";
    $("fb").innerText = `‚úÖ Correcto. (+${gain} XP)`;
    speak("Correcto. Muy bien.", T.esLang, T.pitchES, T.rateES);

    $("nextLockChip").innerText = "‚úÖ Puedes pasar";
    $("nextBtn").disabled = false;
    $("nextBtn").classList.remove("lock");

    // actualiza stats
    renderUnits();
    $("statXP").innerText = state.xp;
    $("statStreak").innerText = state.streak;
    $("statLevel").innerText = `Nivel ${levelFromXP(state.xp)}`;
    const pct = progressPct();
    $("pct").innerText = `${pct}%`;
    $("fill").style.width = `${pct}%`;
    return;
  }

  // Incorrecto: correcci√≥n humana en espa√±ol (intenci√≥n + faltantes)
  state.streak = 0;
  state.lastWasCorrect = false;
  saveState();

  const tip = coachTip(user, correct);
  $("fb").className = "feedback bad";
  $("fb").innerHTML = `‚ùå Te entend√≠, pero no est√° correcto.<br><br>
    ‚úÖ Correcto: <b>${L.en}</b><br>
    üßë‚Äçüè´ Tutor: ${tip}
  `;
  speak("No. Int√©ntalo otra vez.", T.esLang, T.pitchES, T.rateES);

  $("nextLockChip").innerText = "üîí Debes acertar para pasar";
  $("nextBtn").disabled = true;
  $("nextBtn").classList.add("lock");

  // sube pista autom√°tica tras fallo
  state.hintShown = true;
  saveState();
  $("hint").innerText = buildHint(L);

  // actualiza stats streak
  $("statStreak").innerText = state.streak;
}

function fail(msg){
  $("fb").className = "feedback bad";
  $("fb").innerText = `‚ùå ${msg}`;
  state.streak = 0;
  state.lastWasCorrect = false;
  saveState();
  $("statStreak").innerText = state.streak;
  $("nextBtn").disabled = true;
  $("nextBtn").classList.add("lock");
  $("nextLockChip").innerText = "üîí Debes acertar para pasar";
}

function coachTip(user, correct){
  // Heur√≠sticas simples y √∫tiles (sin IA externa)
  const uToks = user.replace(/[?.!]/g,"").split(" ").filter(Boolean);
  const cToks = correct.replace(/[?.!]/g,"").split(" ").filter(Boolean);

  const missing = cToks.filter(w => !uToks.includes(w));
  const extra = uToks.filter(w => !cToks.includes(w));

  // Errores t√≠picos
  if(correct.includes("don't") && user.includes("no ")) return "En ingl√©s no se usa ‚Äúno‚Äù as√≠. Usa **don't** (do not).";
  if(correct.includes("can't") && user.includes("no ")) return "En ingl√©s no se usa ‚Äúno‚Äù as√≠. Usa **can't** (cannot).";
  if(correct.includes("what's") && user.includes("whats")) return "Pon ap√≥strofe: **what's** (what is).";
  if(correct.includes("i'm") && user.includes("im ")) return "Pon ap√≥strofe: **I'm** (I am).";

  if(missing.length){
    return `Te faltan palabras: <b>${missing.slice(0,6).join(", ")}</b>. Escr√≠belo completo.`;
  }
  if(extra.length){
    return `Tienes palabras de m√°s: <b>${extra.slice(0,6).join(", ")}</b>. Intenta m√°s simple.`;
  }

  // Orden
  const sameSet = cToks.every(w=>uToks.includes(w)) && uToks.every(w=>cToks.includes(w));
  if(sameSet && user !== correct){
    return "Tienes las palabras, pero el **orden** est√° mal. Usa el Word Bank para acomodarlo y luego escribe.";
  }

  return "Casi. Escucha el ingl√©s (üîä) y copia la estructura exacta. Luego lo har√°s sin ayuda.";
}

/* =========================
   Navegaci√≥n
   ========================= */
function next(){
  // Duro: no pasa si no acert√≥
  if(!state.lastWasCorrect){
    $("fb").className = "feedback bad";
    $("fb").innerText = "üîí No puedes pasar todav√≠a. Primero acierta una vez.";
    return;
  }
  stopVoice();
  state.idx = Math.min(state.idx + 1, LESSONS.length - 1);
  state.lastWasCorrect = false;
  state.hintShown = false;
  chosenTokens = [];
  saveState();
  renderLesson();
}

/* =========================
   Init
   ========================= */
renderUnits();
renderLesson();
</script>
</body>
</html>
