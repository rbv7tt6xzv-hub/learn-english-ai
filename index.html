<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Tutor AI ‚Äî Interactivo</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#101b33; --line:#22304f;
      --text:#e5e7eb; --muted:#94a3b8; --green:#22c55e; --red:#ef4444; --yellow:#fbbf24;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:linear-gradient(180deg,#070c16,#0b1220 35%,#070c16);
    }
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .topbar{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      background:rgba(15,23,42,.65); border:1px solid var(--line);
      padding:14px 14px; border-radius:18px; position:sticky; top:10px; z-index:10;
      backdrop-filter: blur(8px);
    }
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand b{font-size:15px}
    .brand small{color:var(--muted)}
    .pill{
      display:flex;gap:10px;align-items:center; flex-wrap:wrap; justify-content:flex-end;
      font-size:12px; color:var(--muted);
    }
    .pill span{
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:rgba(16,27,51,.6)
    }
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px;margin-top:14px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .panel{
      background:rgba(15,23,42,.55);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }
    .h2{display:flex;align-items:center;justify-content:space-between;gap:10px;margin:0 0 10px 0}
    .h2 h2{font-size:14px;margin:0;color:var(--text)}
    .h2 small{color:var(--muted)}
    .card{
      background:rgba(16,27,51,.7);
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
    }

    /* Tutor block */
    .tutorHeader{display:flex;gap:12px;align-items:center;justify-content:space-between}
    .tutorLeft{display:flex;gap:10px;align-items:center}
    .avatar{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(180deg, rgba(34,197,94,.22), rgba(148,163,184,.12));
      border:1px solid rgba(34,197,94,.35);
      display:grid;place-items:center;font-size:18px
    }
    .tutorMeta{display:flex;flex-direction:column;line-height:1.15}
    .tutorMeta b{font-size:13px}
    .tutorMeta small{color:var(--muted);font-size:12px}
    .statusDot{width:8px;height:8px;border-radius:50%}
    .statusRow{display:flex;gap:8px;align-items:center}

    .btnRow{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    button{
      appearance:none;border:0;cursor:pointer;
      padding:12px 14px;border-radius:14px;font-weight:800;
      background:rgba(148,163,184,.12);color:var(--text);
      border:1px solid var(--line);
    }
    button.primary{background:var(--green);color:#04120a;border-color:rgba(34,197,94,.6)}
    button.danger{background:var(--red);color:#1b0202;border-color:rgba(239,68,68,.6)}
    button.warn{background:var(--yellow);color:#1a1200;border-color:rgba(251,191,36,.7)}
    button:disabled{opacity:.55;cursor:not-allowed}

    /* Chat */
    .chat{
      margin-top:12px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(11,18,32,.55);
      padding:12px;
      height:320px;
      overflow:auto;
    }
    .msg{display:flex;gap:10px;margin:10px 0}
    .msg .bubble{
      max-width:88%;
      padding:10px 12px;border-radius:16px;border:1px solid var(--line);
      background:rgba(16,27,51,.72)
    }
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{
      background:rgba(34,197,94,.15);
      border-color:rgba(34,197,94,.35)
    }
    .msg.ai .bubble{background:rgba(148,163,184,.10)}
    .bubble .meta{font-size:11px;color:var(--muted);margin-bottom:6px}
    .bubble .text{white-space:pre-wrap}

    .inputRow{display:flex;gap:10px;margin-top:10px}
    .inputRow input{
      flex:1;
      padding:12px 12px;border-radius:14px;border:1px solid var(--line);
      background:rgba(16,27,51,.7);color:var(--text);
      outline:none;
    }
    .helper{color:var(--muted);font-size:12px;margin-top:8px;line-height:1.4}
    .tiny{font-size:11px;color:var(--muted)}

    /* Exercise */
    .prompt{font-size:15px;margin:0 0 10px 0;line-height:1.35}
    .tag{font-size:12px;color:var(--muted)}
    .box{
      border:1px dashed rgba(148,163,184,.35);
      border-radius:16px;padding:12px;background:rgba(16,27,51,.35);
      min-height:52px;display:flex;align-items:center;gap:8px;flex-wrap:wrap
    }
    .chip{
      padding:8px 10px;border-radius:999px;border:1px solid var(--line);
      background:rgba(16,27,51,.7);cursor:pointer;font-weight:800
    }
    .chip:active{transform:scale(.98)}
    .note{font-size:12px;color:var(--muted);margin-top:10px}
    .result{
      margin-top:12px;border:1px solid var(--line);border-radius:16px;
      padding:12px;background:rgba(16,27,51,.55)
    }
    .ok{color:#a7f3d0}
    .bad{color:#fecaca}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <b>English Tutor AI ‚Äî Interactivo</b>
        <small>Tutor visible + chat + correcci√≥n + micr√≥fono + voz (opcional)</small>
      </div>
      <div class="pill">
        <span id="pillTutor">ü§ñ Tutor: Local (Listo)</span>
        <span id="pillMic">üéôÔ∏è Mic: sin probar</span>
        <span id="pillVoice">üîä Voz: lista</span>
      </div>
    </div>

    <div class="grid">
      <!-- Tutor -->
      <div class="panel">
        <div class="h2">
          <h2>ü§ñ Tutor AI (Interactivo)</h2>
          <small>Responde siempre (Local o IA real)</small>
        </div>

        <div class="card">
          <div class="tutorHeader">
            <div class="tutorLeft">
              <div class="avatar">üßë‚Äçüè´</div>
              <div class="tutorMeta">
                <b id="tutorName">Teacher Emma (AI)</b>
                <div class="statusRow">
                  <div class="statusDot" id="statusDot" style="background: var(--muted)"></div>
                  <small id="statusText">Idle</small>
                </div>
              </div>
            </div>

            <div class="btnRow">
              <button id="btnSpeak" class="primary">üé§ Hablar (EN)</button>
              <button id="btnStop" class="danger" disabled>‚èπÔ∏è Parar</button>
              <button id="btnSay" class="warn">üîä Hablar respuesta</button>
              <button id="btnHint">üí° Pista</button>
            </div>
          </div>

          <div class="chat" id="chat"></div>

          <div class="inputRow">
            <input id="userInput" placeholder="Escribe en ingl√©s..." autocomplete="off" />
            <button id="btnSend" class="primary">Enviar</button>
          </div>

          <div class="helper">
            iPhone: si el mic falla ‚Üí <b>Ajustes ‚Üí Safari ‚Üí Micr√≥fono ‚Üí Permitir</b> y en la p√°gina <b>aA ‚Üí Configuraci√≥n del sitio ‚Üí Micr√≥fono ‚Üí Permitir</b>.
          </div>
          <div class="tiny" style="margin-top:8px">
            IA real opcional: pega tu endpoint en el c√≥digo (AI_ENDPOINT). Si no, el Tutor Local siempre responde.
          </div>
        </div>
      </div>

      <!-- Ejercicio -->
      <div class="panel">
        <div class="h2">
          <h2>üß© Ejercicio (Word Bank)</h2>
          <small>Arma + revisa + env√≠a al tutor</small>
        </div>

        <div class="card">
          <p class="prompt"><span class="tag">Meta de hoy</span><br>
            Construye y di: <b>I need help.</b> Luego s√∫belo a: <b>I need help with English.</b>
          </p>

          <div class="box" id="bank">
            <div class="chip" data-word="I">I</div>
            <div class="chip" data-word="need">need</div>
            <div class="chip" data-word="help.">help.</div>
            <div class="chip" data-word="with">with</div>
            <div class="chip" data-word="English.">English.</div>
            <div class="chip" data-word="please.">please.</div>
          </div>

          <div class="note">Tu frase (toca para quitar palabras):</div>
          <div class="box" id="phraseBox"><span class="muted">Toca palabras para armar la oraci√≥n‚Ä¶</span></div>

          <div class="btnRow" style="margin-top:10px;justify-content:flex-start">
            <button id="btnRedo">‚Ü©Ô∏è Rehacer</button>
            <button id="btnToInput">‚û°Ô∏è Pasar al input</button>
            <button id="btnReview" class="primary">‚úÖ Revisar + enviar</button>
          </div>

          <div class="result" id="reviewBox" style="display:none"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ==========================================================
 *  (2) IA real opcional: pega aqu√≠ tu endpoint cuando lo tengas
 *  Si est√° vac√≠o, el Tutor Local SIEMPRE responde (modo 3).
 *  ========================================================== */
const AI_ENDPOINT = ""; // ejemplo: "https://tu-app.vercel.app/api/tutor"

/** ===== Helpers UI ===== */
const el = (id) => document.getElementById(id);
const chat = el("chat");
const statusDot = el("statusDot");
const statusText = el("statusText");
const pillMic = el("pillMic");
const pillTutor = el("pillTutor");
const pillVoice = el("pillVoice");

function setStatus(type, text){
  const map = {
    idle: "var(--muted)",
    listening: "var(--yellow)",
    thinking: "rgba(148,163,184,.9)",
    ok: "var(--green)",
    bad: "var(--red)"
  };
  statusDot.style.background = map[type] || "var(--muted)";
  statusText.textContent = text;
}

let lastTutorText = "";

function addMsg(role, text){
  const row = document.createElement("div");
  row.className = "msg " + (role === "user" ? "user" : "ai");
  const bubble = document.createElement("div");
  bubble.className = "bubble";

  const meta = document.createElement("div");
  meta.className = "meta";
  meta.textContent = role === "user" ? "You" : "Tutor AI";

  const body = document.createElement("div");
  body.className = "text";
  body.textContent = text;

  bubble.appendChild(meta);
  bubble.appendChild(body);
  row.appendChild(bubble);
  chat.appendChild(row);
  chat.scrollTop = chat.scrollHeight;

  if(role === "ai") lastTutorText = text;
}

function normalize(s){
  return (s || "").trim().replace(/\s+/g," ");
}

function smartPolish(t){
  let s = normalize(t);
  if(!s) return s;
  s = s.replace(/\bi\b/g,"I");
  s = s[0].toUpperCase() + s.slice(1);
  if(!/[.!?]$/.test(s)) s += ".";
  return s;
}

/** ===== (3) Tutor Local (interacci√≥n real sin internet) ===== */
function localTutor(userText){
  const t = normalize(userText);
  const low = t.toLowerCase();

  let score = 75;
  let correction = "";
  let reply = "";

  if(!t){
    return { reply: "I didn‚Äôt catch that. Type: ‚ÄúI need help.‚Äù", score: 0, correction: "" };
  }

  // Objetivo principal
  if(low === "i need help" || low === "i need help."){
    score = 95;
    correction = "I need help.";
    reply =
`‚úÖ Correct!
Now upgrade:
‚Ä¢ I need help with English.
‚Ä¢ Can you help me, please?

Say it again slowly: ‚ÄúI need help.‚Äù`;
    return { reply, score, correction };
  }

  // Objetivo 2
  if(low.includes("i need help with english")){
    score = 92;
    correction = "I need help with English.";
    reply =
`‚úÖ Nice!
Now answer:
üëâ What do you need help with?

Example:
‚Ä¢ I need help with my pronunciation.`;
    return { reply, score, correction };
  }

  // Si tiene help/need pero est√° raro
  if(low.includes("need") && low.includes("help") && !low.startsWith("i need")){
    score = 55;
    correction = "I need help.";
    reply =
`‚ùå Almost. In English: Subject + verb.
Try:
‚Ä¢ I need help.

Repeat: ‚ÄúI need help.‚Äù`;
    return { reply, score, correction };
  }

  // Respuesta general
  correction = smartPolish(t);
  reply =
`Here is a cleaner version:
‚Ä¢ ${correction}

Now repeat it slowly once.`;
  return { reply, score, correction };
}

function formatFooter(ans){
  const bits = [];
  if(ans.correction) bits.push("Correction: " + ans.correction);
  if(typeof ans.score === "number") bits.push("Score: " + ans.score + "/100");
  return bits.length ? ("\n\n‚Äî\n" + bits.join("\n")) : "";
}

/** ===== (2) IA Real opcional con fallback a Local ===== */
async function tutorRespond(userText){
  if(AI_ENDPOINT){
    try{
      setStatus("thinking","Thinking‚Ä¶");
      pillTutor.textContent = "ü§ñ Tutor: IA real (Conectada)";
      const res = await fetch(AI_ENDPOINT,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({
          message: userText,
          context: { goal: "I need help.", level: "A1/A2" }
        })
      });
      if(res.ok){
        const data = await res.json();
        const reply = data.reply || "(No reply)";
        const score = (typeof data.score === "number") ? data.score : null;
        const correction = data.correction || "";
        setStatus("ok","Replied");
        return { reply, score, correction };
      }
    }catch(e){
      // cae a local
    }
  }
  pillTutor.textContent = "ü§ñ Tutor: Local (Listo)";
  const ans = localTutor(userText);
  setStatus(ans.score >= 80 ? "ok" : "bad", ans.score >= 80 ? "Good" : "Needs work");
  return ans;
}

/** ===== Voz (Text-to-Speech) ===== */
function speak(text){
  if(!("speechSynthesis" in window)){
    pillVoice.textContent = "üîä Voz: no soportada";
    return;
  }
  const main = (text || "").split("\n\n‚Äî\n")[0]; // no leer score/correction
  if(!main.trim()) return;

  try{
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(main);
    u.lang = "en-US";
    window.speechSynthesis.speak(u);
    pillVoice.textContent = "üîä Voz: hablando";
    u.onend = () => pillVoice.textContent = "üîä Voz: lista";
  }catch(e){
    pillVoice.textContent = "üîä Voz: error";
  }
}

/** ===== Mic (Speech-to-Text) ===== */
let recognition = null;

function initMic(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    pillMic.textContent = "üéôÔ∏è Mic: no soportado";
    return null;
  }
  const r = new SR();
  r.lang = "en-US";
  r.interimResults = false;
  r.maxAlternatives = 1;

  r.onstart = () => {
    setStatus("listening","Listening‚Ä¶");
    pillMic.textContent = "üéôÔ∏è Mic: escuchando";
    el("btnSpeak").disabled = true;
    el("btnStop").disabled = false;
  };

  r.onend = () => {
    el("btnSpeak").disabled = false;
    el("btnStop").disabled = true;
    if(statusText.textContent === "Listening‚Ä¶") setStatus("idle","Idle");
    if(pillMic.textContent === "üéôÔ∏è Mic: escuchando") pillMic.textContent = "üéôÔ∏è Mic: detenido";
  };

  r.onerror = (ev) => {
    setStatus("bad","Mic error");
    pillMic.textContent = "üéôÔ∏è Mic: error (" + (ev.error || "unknown") + ")";
    addMsg("ai","Mic error: " + (ev.error || "unknown") + "\nTip iPhone: Ajustes ‚Üí Safari ‚Üí Micr√≥fono ‚Üí Permitir");
  };

  r.onresult = async (event) => {
    const spoken = event.results?.[0]?.[0]?.transcript || "";
    pillMic.textContent = "üéôÔ∏è Mic: capturado";
    if(spoken){
      addMsg("user", spoken);
      const ans = await tutorRespond(spoken);
      addMsg("ai", ans.reply + formatFooter(ans));
    }else{
      addMsg("ai","I didn‚Äôt catch anything. Try again.");
    }
  };

  pillMic.textContent = "üéôÔ∏è Mic: listo";
  return r;
}

recognition = initMic();

/** ===== Acciones ===== */
async function handleUserText(t){
  const text = normalize(t);
  if(!text) return;
  addMsg("user", text);
  setStatus("thinking","Thinking‚Ä¶");
  const ans = await tutorRespond(text);
  addMsg("ai", ans.reply + formatFooter(ans));
}

el("btnSend").onclick = async () => {
  const t = el("userInput").value;
  el("userInput").value = "";
  await handleUserText(t);
};

el("userInput").addEventListener("keydown",(e)=>{
  if(e.key === "Enter") el("btnSend").click();
});

el("btnHint").onclick = () => {
  addMsg("ai",
`Hint:
Subject + verb ‚Üí ‚ÄúI need ‚Ä¶‚Äù
Try:
‚Ä¢ I need help.
‚Ä¢ I need help with English.`);
};

el("btnSay").onclick = () => {
  if(!lastTutorText){
    addMsg("ai","Say something first, then I‚Äôll read my reply.");
    return;
  }
  speak(lastTutorText);
};

el("btnSpeak").onclick = () => {
  if(!recognition){
    addMsg("ai","Mic not supported here. Type instead.");
    return;
  }
  try{ recognition.start(); }catch(e){}
};

el("btnStop").onclick = () => {
  try{ recognition.stop(); }catch(e){}
};

/** ===== Word Bank ===== */
let phraseWords = [];
const phraseBox = el("phraseBox");

function renderPhrase(){
  phraseBox.innerHTML = "";
  if(phraseWords.length === 0){
    const span = document.createElement("span");
    span.className = "muted";
    span.textContent = "Toca palabras para armar la oraci√≥n‚Ä¶";
    phraseBox.appendChild(span);
    return;
  }
  phraseWords.forEach((w, idx) => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.textContent = w;
    chip.title = "Toca para quitar";
    chip.onclick = () => { phraseWords.splice(idx,1); renderPhrase(); };
    phraseBox.appendChild(chip);
  });
}

el("bank").addEventListener("click",(e)=>{
  const t = e.target;
  if(!t.classList.contains("chip")) return;
  phraseWords.push(t.dataset.word);
  renderPhrase();
});

el("btnRedo").onclick = () => {
  phraseWords = [];
  el("reviewBox").style.display = "none";
  renderPhrase();
};

el("btnToInput").onclick = () => {
  const sentence = phraseWords.join(" ").replace(/\s+([.?!,])/g,"$1");
  el("userInput").value = sentence;
  el("userInput").focus();
};

el("btnReview").onclick = async () => {
  const reviewBox = el("reviewBox");
  const sentence = phraseWords.join(" ").replace(/\s+([.?!,])/g,"$1");
  reviewBox.style.display = "block";

  if(!sentence.trim()){
    reviewBox.innerHTML = `<div class="bad">‚ùå Arma una frase primero.</div>`;
    return;
  }

  const target = "I need help.";
  const polished = smartPolish(sentence);
  const ok = normalize(polished).toLowerCase() === target.toLowerCase();

  reviewBox.innerHTML = ok
    ? `<div class="ok">‚úÖ Correcto: <b>${target}</b></div><div class="muted">Enviado al Tutor para subir nivel.</div>`
    : `<div class="bad">‚ùå Casi. Recomendado: <b>${target}</b></div><div class="muted">Tip: ‚ÄúI‚Äù va antes de ‚Äúneed‚Äù.</div>`;

  await handleUserText(polished);
};

renderPhrase();

/** ===== Mensaje inicial (tutor interact√∫a desde el inicio) ===== */
setStatus("idle","Idle");
addMsg("ai",
`Hi! I‚Äôm Teacher Emma (AI).
Type a sentence or tap üé§ to speak.

Start with:
‚ÄúI need help.‚Äù`);
addMsg("ai", "After I reply, tap üîä Hablar respuesta to hear my voice (if supported).");
</script>
</body>
</html>
