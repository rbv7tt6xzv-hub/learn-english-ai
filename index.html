<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>English Tutor AI ‚Äî Curso Completo (Duro-Humano)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --card:#101b33; --line:#22304f;
      --text:#e5e7eb; --muted:#94a3b8; --green:#22c55e; --red:#ef4444; --yellow:#fbbf24;
      --radius:16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,#070c16,#0b1220 35%,#070c16);color:var(--text);
      font-family:system-ui,-apple-system,Arial,sans-serif;min-height:100vh}
    .app{display:grid;grid-template-columns:1fr;gap:14px;max-width:1100px;margin:0 auto;padding:16px}
    @media (min-width:920px){.app{grid-template-columns:360px 1fr}}
    .panel{background:rgba(15,23,42,.86);border:1px solid var(--line);border-radius:var(--radius);padding:14px;
      box-shadow:0 12px 30px rgba(0,0,0,.35);backdrop-filter:blur(8px)}
    h1{margin:0;font-size:18px}
    .sub{margin:6px 0 0;color:var(--muted);font-size:13px;line-height:1.35}
    .chip{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--line);background:#0b1220;color:#cbd5e1;
      padding:7px 10px;border-radius:999px;font-size:12px}
    .topRow{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-top:10px}
    .statGrid{display:grid;gap:10px;margin-top:12px}
    .stat{background:#0b1220;border:1px solid var(--line);border-radius:14px;padding:12px;display:flex;justify-content:space-between;align-items:center}
    .k{color:var(--muted);font-size:12px}
    .v{font-weight:900;font-size:16px}
    .bar{height:10px;border-radius:999px;background:#070c16;border:1px solid var(--line);overflow:hidden}
    .fill{height:100%;width:0%;background:var(--green)}
    .small{color:var(--muted);font-size:12px;line-height:1.35}
    .divider{height:1px;background:var(--line);margin:12px 0}

    .unit{margin-top:10px;padding:10px;border-radius:14px;border:1px solid var(--line);background:#0b1220}
    .unitTitle{font-weight:900;margin:0;font-size:13px}
    .unitDesc{margin:4px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
    .unitBtnRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    button{cursor:pointer;border:none;border-radius:14px;padding:12px 12px;font-weight:900;font-size:14px}
    .btn{flex:1;min-width:160px}
    .primary{background:var(--green);color:#05210f}
    .secondary{background:#334155;color:#e2e8f0}
    .warn{background:var(--yellow);color:#1f1300}
    .danger{background:var(--red);color:#fff}
    .tinyBtn{padding:8px 10px;border-radius:999px;font-size:12px;font-weight:800;background:#111a2e;border:1px solid var(--line);color:#e2e8f0}
    .tinyBtn.active{border-color:rgba(34,197,94,.7);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .header{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .lessonCard{margin-top:12px;background:#0b1220;border:1px solid var(--line);border-radius:var(--radius);padding:14px}
    .scene{margin:0;color:var(--muted);font-size:13px;line-height:1.35}
    .prompt{margin-top:10px;background:#111a2e;border:1px solid #25385e;border-radius:14px;padding:12px}
    .label{color:var(--muted);font-size:12px;margin:0 0 6px}
    .es{margin:0;font-size:18px;font-weight:950}
    .hint{margin:10px 0 0;color:#cbd5e1;font-size:13px;line-height:1.35}
    .grid{display:grid;gap:12px;margin-top:12px}
    @media (min-width:760px){.grid{grid-template-columns:1fr 1fr}}
    input{width:100%;margin-top:8px;background:#0b1220;color:var(--text);border:1px solid var(--line);border-radius:14px;
      padding:12px;font-size:16px;outline:none}
    .bank{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .tok{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#0b1220;color:#fff;font-weight:900;font-size:13px}
    .tok:disabled{opacity:.5}
    .built{margin-top:10px;padding:10px;border-radius:14px;border:1px dashed var(--line);min-height:48px;background:rgba(7,12,22,.35);color:#cbd5e1}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .feedback{margin-top:12px;font-weight:950;line-height:1.35}
    .ok{color:#86efac}
    .bad{color:#fca5a5}
    .lock{opacity:.7}
    .tutors{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .tutorBtn{display:flex;justify-content:space-between;align-items:center;gap:10px;min-width:210px;background:#0b1220;border:1px solid var(--line);
      color:var(--text);border-radius:14px;padding:10px 10px}
    .tutorBtn.active{border-color:rgba(34,197,94,.7);box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .tName{font-weight:950;font-size:13px}
    .tRole{color:var(--muted);font-size:12px}
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <div class="panel">
      <div class="topRow">
        <div>
          <h1>English Tutor AI üá∫üá∏</h1>
          <p class="sub">Curso completo. Respondes escribiendo, hablando (pronunciaci√≥n) o con Word Bank. Incluye: Dictado + Variantes + Rutas.</p>
        </div>
        <span class="chip">üî• Duro-humano</span>
      </div>

      <div class="statGrid">
        <div class="stat"><div><div class="k">Lecci√≥n</div><div class="v" id="statLesson">1/210</div></div><span class="chip" id="statUnit">Unidad 1.1</span></div>
        <div class="stat"><div><div class="k">XP</div><div class="v" id="statXP">0</div></div><span class="chip" id="statLevel">Nivel 1</span></div>
        <div class="stat"><div><div class="k">Racha</div><div class="v" id="statStreak">0</div></div><span class="chip">‚úÖ</span></div>
        <div class="stat" style="display:block">
          <div class="k">Progreso (ruta actual)</div>
          <div class="bar" style="margin-top:8px"><div class="fill" id="fill"></div></div>
          <div class="small" id="pct" style="margin-top:8px">0%</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="small">Rutas (filtra el curso):</div>
      <div class="actions" style="margin-top:10px">
        <button class="tinyBtn active" id="rAll" type="button" onclick="setRoute('ALL')">Todo</button>
        <button class="tinyBtn" id="rSurv" type="button" onclick="setRoute('SURVIVAL')">Supervivencia</button>
        <button class="tinyBtn" id="rWork" type="button" onclick="setRoute('WORK')">Trabajo</button>
        <button class="tinyBtn" id="rNat" type="button" onclick="setRoute('NATURAL')">Natural</button>
      </div>

      <div class="divider"></div>

      <div class="actions">
        <button class="btn secondary" onclick="jumpToFirstIncomplete()">‚ñ∂Ô∏è Continuar</button>
        <button class="btn secondary" onclick="resetProgress()">üîÅ Reiniciar</button>
        <button class="btn danger" onclick="stopAllAudio()">üîá Parar voz/mic</button>
      </div>

      <div class="divider"></div>

      <div id="units"></div>
    </div>

    <!-- Main -->
    <div class="panel">
      <div class="header">
        <div>
          <div class="chip" id="lessonMeta">Unidad</div>
          <h2 style="margin:10px 0 0; font-size:18px" id="lessonTitle">Cargando‚Ä¶</h2>
          <p class="small" id="lessonSub" style="margin:6px 0 0">‚Ä¶</p>
        </div>
        <div class="chip" id="nextLockChip">üîí Debes acertar para pasar</div>
      </div>

      <div class="tutors">
        <button class="tutorBtn active" id="t0" onclick="setTutor(0)">
          <div><div class="tName">üë©‚Äçüè´ Ana</div><div class="tRole">Corrige en espa√±ol</div></div>
          <span class="chip">ES‚ÜíEN</span>
        </button>
        <button class="tutorBtn" id="t1" onclick="setTutor(1)">
          <div><div class="tName">üë®‚Äçüè´ Mike</div><div class="tRole">Pronunciaci√≥n USA</div></div>
          <span class="chip">Audio EN</span>
        </button>
        <button class="tutorBtn" id="t2" onclick="setTutor(2)">
          <div><div class="tName">üßë‚Äçüè´ Alex</div><div class="tRole">Ingl√©s natural</div></div>
          <span class="chip">Fluidez</span>
        </button>
      </div>

      <div class="lessonCard">
        <p class="scene" id="scene">‚Ä¶</p>

        <div class="prompt">
          <p class="label" id="promptLabel">Tutor pregunta (ES):</p>
          <p class="es" id="esText">‚Ä¶</p>
          <p class="hint" id="hint">üí° Pista oculta (toca ‚ÄúPista‚Äù)</p>
          <p class="small" id="variants" style="margin:10px 0 0"></p>
        </div>

        <!-- MODOS -->
        <div class="actions">
          <button class="tinyBtn active" id="mTranslate" type="button" onclick="setExerciseMode('TRANSLATE')">Modo Traducci√≥n</button>
          <button class="tinyBtn" id="mDictation" type="button" onclick="setExerciseMode('DICTATION')">Modo Dictado</button>
          <button class="tinyBtn" id="mSpeak" type="button" onclick="setExerciseMode('SPEAK')">Modo Pronunciaci√≥n üé§</button>
        </div>

        <div class="grid">
          <div class="prompt">
            <p class="label">‚úçÔ∏è Responder escribiendo (EN)</p>
            <input id="typed" placeholder="Escribe en ingl√©s‚Ä¶" />
            <div class="small" id="typedTip">Primero intenta sin ayuda. Si fallas, usa pista o Word Bank.</div>

            <div class="actions" style="margin-top:10px">
              <button class="btn secondary" type="button" onclick="startSpeakPractice()">üé§ Hablar (EN) y evaluar</button>
              <button class="btn danger" type="button" onclick="stopVoiceInput()">‚èπÔ∏è Parar micr√≥fono</button>
            </div>

            <div class="small" id="micStatus" style="margin-top:8px"></div>
          </div>

          <div class="prompt">
            <p class="label">üß© Armar con palabras (Word Bank)</p>
            <div class="bank" id="bank"></div>
            <div class="built">Tu frase: <span id="builtText" style="font-weight:900"></span></div>
            <div class="actions" style="margin-top:10px">
              <button class="btn secondary" onclick="resetWordBank()">‚Ü©Ô∏è Rehacer</button>
              <button class="btn secondary" onclick="copyBuiltToInput()">‚û°Ô∏è Pasar al input</button>
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn warn" onclick="speakQuestion()">üîä Pregunta (ES)</button>
          <button class="btn secondary" onclick="speakAnswer()">üîä Ingl√©s (EN)</button>
          <button class="btn secondary" onclick="showHint()">üí° Pista</button>
        </div>

        <div class="actions">
          <button class="btn primary" onclick="check()">‚úÖ Revisar</button>
          <button class="btn secondary" id="nextBtn" onclick="next()">‚û°Ô∏è Siguiente</button>
        </div>

        <div class="feedback" id="fb"></div>
      </div>
    </div>
  </div>

<script>
/* =========================
   Unidades / Rutas (SIN DUPLICADOS)
   ========================= */
const UNITS = [
  { id:"1.1", name:"Unidad 1.1 ‚Äî Entender y pedir ayuda", range:[1,20], desc:"No entiendo, repetir, ayuda." },
  { id:"1.2", name:"Unidad 1.2 ‚Äî Presentarte y conversar", range:[21,40], desc:"Nombre, origen, conversaci√≥n b√°sica." },
  { id:"1.3", name:"Unidad 1.3 ‚Äî Comer, pagar, moverte", range:[41,60], desc:"Restaurante, dinero, direcciones." },
  { id:"2.1", name:"Unidad 2.1 ‚Äî Presente real", range:[61,80], desc:"Estructuras diarias." },
  { id:"2.2", name:"Unidad 2.2 ‚Äî Pasado √∫til", range:[81,100], desc:"Ayer, pas√≥, funcion√≥." },
  { id:"2.3", name:"Unidad 2.3 ‚Äî Futuro pr√°ctico", range:[101,120], desc:"Planes y promesas." },
  { id:"3.1", name:"Unidad 3.1 ‚Äî Trabajo", range:[121,145], desc:"Horario, acceso, tareas." },
  { id:"3.2", name:"Unidad 3.2 ‚Äî Problemas y soluciones", range:[146,170], desc:"Reembolso, reemplazo, acuerdos." },
  { id:"4.1", name:"Unidad 4.1 ‚Äî Respuestas reales", range:[171,190], desc:"Respuestas cortas y naturales." },
  { id:"4.2", name:"Unidad 4.2 ‚Äî Ingl√©s de la vida real", range:[191,210], desc:"Gonna/wanna y frases reales." },
];

function routeOfUnit(unitId){
  if(["1.1","1.2","1.3","2.1","2.2","2.3"].includes(unitId)) return "SURVIVAL";
  if(["3.1","3.2"].includes(unitId)) return "WORK";
  if(["4.1","4.2"].includes(unitId)) return "NATURAL";
  return "ALL";
}

/* =========================
   Curso (210 lecciones)
   FIXES:
   - 22 y 24: respuestas libres (free:true) SIN "‚Ä¶"
   - 26: variantes reales
   - 8: variante correcta (no "Do you speak English?")
   ========================= */
const LESSONS = [
  // 1.1
  {id:1, unit:"1.1", es:"No entiendo", en:"I don't understand.", acceptable:["I do not understand."]},
  {id:2, unit:"1.1", es:"¬øPuede repetir?", en:"Can you repeat?", acceptable:["Can you say it again?","Could you repeat that?"]},
  {id:3, unit:"1.1", es:"M√°s despacio, por favor", en:"More slowly, please.", acceptable:["Can you speak more slowly, please?"]},
  {id:4, unit:"1.1", es:"¬øQu√© significa‚Ä¶?", en:"What does it mean?", acceptable:["What does that mean?"]},
  {id:5, unit:"1.1", es:"¬øC√≥mo se dice ‚Ä¶ en ingl√©s?", en:"How do you say it in English?", acceptable:["How do you say this in English?"]},
  {id:6, unit:"1.1", es:"Necesito ayuda", en:"I need help.", acceptable:["Can you help me?"]},
  {id:7, unit:"1.1", es:"Estoy perdido", en:"I'm lost.", acceptable:["I got lost."]},
  {id:8, unit:"1.1", es:"¬øHabla espa√±ol?", en:"Do you speak Spanish?", acceptable:["Do you speak Spanish?"]},
  {id:9, unit:"1.1", es:"No s√©", en:"I don't know.", acceptable:["I have no idea."]},
  {id:10, unit:"1.1", es:"Un momento, por favor", en:"One moment, please.", acceptable:["Just a moment, please."]},
  {id:11, unit:"1.1", es:"Espere un segundo", en:"Wait a second.", acceptable:["Hold on a second."]},
  {id:12, unit:"1.1", es:"No escucho bien", en:"I can't hear well.", acceptable:["I can't hear you well."]},
  {id:13, unit:"1.1", es:"No entiendo eso", en:"I don't understand that.", acceptable:["I don't get that."]},
  {id:14, unit:"1.1", es:"¬øPuede escribirlo?", en:"Can you write it?", acceptable:["Can you write that down?"]},
  {id:15, unit:"1.1", es:"¬øPuede mostrarme?", en:"Can you show me?", acceptable:["Can you show me that?"]},
  {id:16, unit:"1.1", es:"Repita otra vez", en:"Repeat it again.", acceptable:["Say it again, please."]},
  {id:17, unit:"1.1", es:"Est√° bien / Est√° mal", en:"It's okay / It's wrong.", acceptable:["That's right / That's wrong."]},
  {id:18, unit:"1.1", es:"¬øEs correcto?", en:"Is it correct?", acceptable:["Is this correct?"]},
  {id:19, unit:"1.1", es:"Gracias por la ayuda", en:"Thanks for the help.", acceptable:["Thank you for your help."]},
  {id:20, unit:"1.1", es:"Perd√≥n, me equivoqu√©", en:"Sorry, I made a mistake.", acceptable:["My bad.","Sorry, that was my mistake."]},

  // 1.2
  {id:21, unit:"1.2", es:"¬øC√≥mo te llamas?", en:"What's your name?", acceptable:["What is your name?"]},
  {id:22, unit:"1.2", es:"Me llamo‚Ä¶", en:"My name is", acceptable:["I'm"], free:true},
  {id:23, unit:"1.2", es:"¬øDe d√≥nde eres?", en:"Where are you from?", acceptable:["Where do you come from?"]},
  {id:24, unit:"1.2", es:"Soy de‚Ä¶", en:"I'm from", acceptable:["I'm originally from"], free:true},
  {id:25, unit:"1.2", es:"Mucho gusto", en:"Nice to meet you.", acceptable:["Nice meeting you."]},
  {id:26, unit:"1.2", es:"Igualmente / El gusto es m√≠o", en:"Nice to meet you too.", acceptable:["You too.","The pleasure is mine.","Pleasure is mine."]},
  {id:27, unit:"1.2", es:"¬øCu√°ntos a√±os tienes?", en:"How old are you?", acceptable:[]},
  {id:28, unit:"1.2", es:"Tengo 30 a√±os", en:"I'm 30 years old.", acceptable:["I am 30."]},
  {id:29, unit:"1.2", es:"¬øD√≥nde vives?", en:"Where do you live?", acceptable:["Where are you living?"]},
  {id:30, unit:"1.2", es:"Vivo aqu√≠", en:"I live here.", acceptable:["I live around here."]},
  {id:31, unit:"1.2", es:"¬øA qu√© te dedicas?", en:"What do you do?", acceptable:["What do you do for work?"]},
  {id:32, unit:"1.2", es:"Trabajo en‚Ä¶", en:"I work in‚Ä¶", acceptable:["I work at‚Ä¶"]},
  {id:33, unit:"1.2", es:"Estoy buscando trabajo", en:"I'm looking for a job.", acceptable:["I'm job hunting."]},
  {id:34, unit:"1.2", es:"Soy nuevo aqu√≠", en:"I'm new here.", acceptable:["I just moved here."]},
  {id:35, unit:"1.2", es:"¬øHace cu√°nto tiempo est√°s aqu√≠?", en:"How long have you been here?", acceptable:["How long have you lived here?"]},
  {id:36, unit:"1.2", es:"Hace dos meses", en:"For two months.", acceptable:["I've been here for two months."]},
  {id:37, unit:"1.2", es:"¬øTe gusta aqu√≠?", en:"Do you like it here?", acceptable:["How do you like it here?"]},
  {id:38, unit:"1.2", es:"S√≠ / No", en:"Yes / No.", acceptable:["Yeah / Nope."]},
  {id:39, unit:"1.2", es:"M√°s o menos", en:"More or less.", acceptable:["Kind of."]},
  {id:40, unit:"1.2", es:"Nos vemos luego", en:"See you later.", acceptable:["See you."]},

  // 1.3
  {id:41, unit:"1.3", es:"Quiero esto", en:"I want this.", acceptable:["I'd like this."]},
  {id:42, unit:"1.3", es:"Necesito eso", en:"I need that.", acceptable:[]},
  {id:43, unit:"1.3", es:"¬øCu√°nto cuesta?", en:"How much is it?", acceptable:["How much does it cost?"]},
  {id:44, unit:"1.3", es:"Es muy caro", en:"It's very expensive.", acceptable:["That's too expensive."]},
  {id:45, unit:"1.3", es:"Est√° bien / Est√° mal", en:"It's good / It's bad.", acceptable:["It's fine / It's not good."]},
  {id:46, unit:"1.3", es:"No es lo que ped√≠", en:"This is not what I ordered.", acceptable:["I didn't order this."]},
  {id:47, unit:"1.3", es:"¬øD√≥nde est√° el ba√±o?", en:"Where is the bathroom?", acceptable:["Where's the restroom?"]},
  {id:48, unit:"1.3", es:"¬øPuedo pagar con tarjeta?", en:"Can I pay with card?", acceptable:["Can I pay by card?","Do you take cards?"]},
  {id:49, unit:"1.3", es:"¬øAceptan efectivo?", en:"Do you accept cash?", acceptable:["Do you take cash?"]},
  {id:50, unit:"1.3", es:"La cuenta, por favor", en:"The check, please.", acceptable:["Can I get the check, please?"]},
  {id:51, unit:"1.3", es:"Tengo hambre", en:"I'm hungry.", acceptable:[]},
  {id:52, unit:"1.3", es:"Tengo sed", en:"I'm thirsty.", acceptable:[]},
  {id:53, unit:"1.3", es:"¬øA qu√© hora abre?", en:"What time do you open?", acceptable:["What time are you open?"]},
  {id:54, unit:"1.3", es:"¬øA qu√© hora cierra?", en:"What time do you close?", acceptable:["What time do you close today?"]},
  {id:55, unit:"1.3", es:"Estoy esperando", en:"I'm waiting.", acceptable:["I'm waiting for someone."]},
  {id:56, unit:"1.3", es:"Es aqu√≠", en:"It's here.", acceptable:["Right here."]},
  {id:57, unit:"1.3", es:"Es all√°", en:"It's over there.", acceptable:["Over there."]},
  {id:58, unit:"1.3", es:"A la derecha / izquierda", en:"To the right / left.", acceptable:["On the right / left."]},
  {id:59, unit:"1.3", es:"Cerca / lejos", en:"Near / far.", acceptable:["It's close / It's far."]},
  {id:60, unit:"1.3", es:"Gracias, ya com√≠", en:"Thanks, I already ate.", acceptable:["No thanks, I already ate."]},

  // 2.1
  {id:61, unit:"2.1", es:"Trabajo aqu√≠", en:"I work here.", acceptable:[]},
  {id:62, unit:"2.1", es:"Estoy trabajando", en:"I'm working.", acceptable:["I am working."]},
  {id:63, unit:"2.1", es:"No trabajo hoy", en:"I don't work today.", acceptable:["I'm not working today."]},
  {id:64, unit:"2.1", es:"Trabajo ma√±ana", en:"I work tomorrow.", acceptable:["I'm working tomorrow."]},
  {id:65, unit:"2.1", es:"Necesito tiempo", en:"I need time.", acceptable:["I need some time."]},
  {id:66, unit:"2.1", es:"Quiero aprender", en:"I want to learn.", acceptable:["I want to learn English."]},
  {id:67, unit:"2.1", es:"Tengo una pregunta", en:"I have a question.", acceptable:["Can I ask a question?"]},
  {id:68, unit:"2.1", es:"No tengo tiempo", en:"I don't have time.", acceptable:["I don't have enough time."]},
  {id:69, unit:"2.1", es:"Puedo hacerlo", en:"I can do it.", acceptable:["I can do this."]},
  {id:70, unit:"2.1", es:"No puedo hacerlo", en:"I can't do it.", acceptable:["I can't do this."]},
  {id:71, unit:"2.1", es:"Tengo un problema", en:"I have a problem.", acceptable:["There's a problem."]},
  {id:72, unit:"2.1", es:"No tengo problema", en:"I don't have a problem.", acceptable:["No problem."]},
  {id:73, unit:"2.1", es:"Estoy listo", en:"I'm ready.", acceptable:["I am ready."]},
  {id:74, unit:"2.1", es:"No estoy listo", en:"I'm not ready.", acceptable:[]},
  {id:75, unit:"2.1", es:"Estoy ocupado", en:"I'm busy.", acceptable:["I'm busy right now."]},
  {id:76, unit:"2.1", es:"Estoy libre", en:"I'm free.", acceptable:["I'm available."]},
  {id:77, unit:"2.1", es:"Estoy cansado", en:"I'm tired.", acceptable:["I'm exhausted."]},
  {id:78, unit:"2.1", es:"Estoy aprendiendo", en:"I'm learning.", acceptable:["I'm learning English."]},
  {id:79, unit:"2.1", es:"Me gusta", en:"I like it.", acceptable:["I like this."]},
  {id:80, unit:"2.1", es:"No me gusta", en:"I don't like it.", acceptable:["I don't like this."]},

  // 2.2
  {id:81, unit:"2.2", es:"Ayer", en:"Yesterday.", acceptable:[]},
  {id:82, unit:"2.2", es:"Ayer trabaj√©", en:"I worked yesterday.", acceptable:[]},
  {id:83, unit:"2.2", es:"Ayer fui", en:"I went yesterday.", acceptable:["I went out yesterday."]},
  {id:84, unit:"2.2", es:"Ayer hice", en:"I did yesterday.", acceptable:["I did it yesterday."]},
  {id:85, unit:"2.2", es:"Fue dif√≠cil", en:"It was hard.", acceptable:["It was difficult."]},
  {id:86, unit:"2.2", es:"Fue f√°cil", en:"It was easy.", acceptable:[]},
  {id:87, unit:"2.2", es:"No funcion√≥", en:"It didn't work.", acceptable:["It wasn't working."]},
  {id:88, unit:"2.2", es:"Funcion√≥", en:"It worked.", acceptable:[]},
  {id:89, unit:"2.2", es:"Llegu√© tarde", en:"I arrived late.", acceptable:["I was late."]},
  {id:90, unit:"2.2", es:"Llegu√© temprano", en:"I arrived early.", acceptable:["I was early."]},
  {id:91, unit:"2.2", es:"Perd√≠ mi trabajo", en:"I lost my job.", acceptable:[]},
  {id:92, unit:"2.2", es:"Encontr√© trabajo", en:"I found a job.", acceptable:["I got a job."]},
  {id:93, unit:"2.2", es:"Tuve un problema", en:"I had a problem.", acceptable:["There was a problem."]},
  {id:94, unit:"2.2", es:"No tuve tiempo", en:"I didn't have time.", acceptable:["I didn't have enough time."]},
  {id:95, unit:"2.2", es:"Fui al doctor", en:"I went to the doctor.", acceptable:[]},
  {id:96, unit:"2.2", es:"Me sent√≠ mal", en:"I felt bad.", acceptable:["I felt sick."]},
  {id:97, unit:"2.2", es:"Me sent√≠ bien", en:"I felt good.", acceptable:["I felt better."]},
  {id:98, unit:"2.2", es:"¬øQu√© pas√≥?", en:"What happened?", acceptable:["What happened here?"]},
  {id:99, unit:"2.2", es:"Pas√≥ ayer", en:"It happened yesterday.", acceptable:["That happened yesterday."]},
  {id:100, unit:"2.2", es:"Todo estuvo bien", en:"Everything was fine.", acceptable:["Everything was okay."]},

  // 2.3
  {id:101, unit:"2.3", es:"Voy a trabajar", en:"I'm going to work.", acceptable:["I'm gonna work."]},
  {id:102, unit:"2.3", es:"Voy a estudiar", en:"I'm going to study.", acceptable:["I'm gonna study."]},
  {id:103, unit:"2.3", es:"Voy a llamar", en:"I'm going to call.", acceptable:["I'll call."]},
  {id:104, unit:"2.3", es:"Voy a regresar", en:"I'm going back.", acceptable:["I'll be back."]},
  {id:105, unit:"2.3", es:"Voy a intentarlo", en:"I'm going to try.", acceptable:["I'll try."]},
  {id:106, unit:"2.3", es:"Ma√±ana trabajo", en:"I work tomorrow.", acceptable:["I'm working tomorrow."]},
  {id:107, unit:"2.3", es:"La pr√≥xima semana", en:"Next week.", acceptable:[]},
  {id:108, unit:"2.3", es:"M√°s tarde", en:"Later.", acceptable:["Later on."]},
  {id:109, unit:"2.3", es:"Pronto", en:"Soon.", acceptable:[]},
  {id:110, unit:"2.3", es:"No hoy", en:"Not today.", acceptable:["Not today, thanks."]},
  {id:111, unit:"2.3", es:"Tal vez", en:"Maybe.", acceptable:[]},
  {id:112, unit:"2.3", es:"Creo que s√≠", en:"I think so.", acceptable:["I think yes."]},
  {id:113, unit:"2.3", es:"Creo que no", en:"I don't think so.", acceptable:["I don't think so, no."]},
  {id:114, unit:"2.3", es:"Veremos", en:"We'll see.", acceptable:["We'll see about that."]},
  {id:115, unit:"2.3", es:"Te llamo luego", en:"I'll call you later.", acceptable:["I'll call you back later."]},
  {id:116, unit:"2.3", es:"Te aviso", en:"I'll let you know.", acceptable:["I'll let you know later."]},
  {id:117, unit:"2.3", es:"No estoy seguro", en:"I'm not sure.", acceptable:["Not sure."]},
  {id:118, unit:"2.3", es:"Estoy seguro", en:"I'm sure.", acceptable:["For sure."]},
  {id:119, unit:"2.3", es:"Espero que s√≠", en:"I hope so.", acceptable:[]},
  {id:120, unit:"2.3", es:"Nos vemos ma√±ana", en:"See you tomorrow.", acceptable:["See you tomorrow then."]},

  // 3.1
  {id:121, unit:"3.1", es:"¬øCu√°l es mi horario?", en:"What is my schedule?", acceptable:["What's my schedule?"]},
  {id:122, unit:"3.1", es:"Entro a las 9", en:"I start at 9.", acceptable:["I start at nine."]},
  {id:123, unit:"3.1", es:"Salgo a las 5", en:"I finish at 5.", acceptable:["I finish at five."]},
  {id:124, unit:"3.1", es:"Estoy en break", en:"I'm on break.", acceptable:["I'm on my break."]},
  {id:125, unit:"3.1", es:"Ya termin√©", en:"I'm done.", acceptable:["I'm finished."]},
  {id:126, unit:"3.1", es:"No he terminado", en:"I'm not finished.", acceptable:["I'm not done yet."]},
  {id:127, unit:"3.1", es:"Necesito m√°s tiempo", en:"I need more time.", acceptable:["I need a bit more time."]},
  {id:128, unit:"3.1", es:"No tengo acceso", en:"I don't have access.", acceptable:["I don't have access yet."]},
  {id:129, unit:"3.1", es:"No funciona", en:"It doesn't work.", acceptable:["It's not working."]},
  {id:130, unit:"3.1", es:"Hay un problema", en:"There is a problem.", acceptable:["There's a problem."]},
  {id:131, unit:"3.1", es:"Fue un error", en:"It was a mistake.", acceptable:["That was a mistake."]},
  {id:132, unit:"3.1", es:"Lo arreglo", en:"I'll fix it.", acceptable:["I can fix it."]},
  {id:133, unit:"3.1", es:"¬øPuede explicarlo otra vez?", en:"Can you explain it again?", acceptable:["Can you go over it again?"]},
  {id:134, unit:"3.1", es:"No entend√≠", en:"I didn't understand.", acceptable:["I didn't get it."]},
  {id:135, unit:"3.1", es:"¬øQu√© hago ahora?", en:"What do I do now?", acceptable:["What should I do now?"]},
  {id:136, unit:"3.1", es:"Estoy aprendiendo", en:"I'm learning.", acceptable:["I'm still learning."]},
  {id:137, unit:"3.1", es:"Soy nuevo", en:"I'm new.", acceptable:["I'm new here."]},
  {id:138, unit:"3.1", es:"Necesito ayuda", en:"I need help.", acceptable:["Can you help me?"]},
  {id:139, unit:"3.1", es:"¬øEst√° bien as√≠?", en:"Is this okay?", acceptable:["Is this fine?"]},
  {id:140, unit:"3.1", es:"Est√° listo", en:"It's ready.", acceptable:["It's done."]},
  {id:141, unit:"3.1", es:"Falta esto", en:"This is missing.", acceptable:["We're missing this."]},
  {id:142, unit:"3.1", es:"Est√° completo", en:"It's complete.", acceptable:["It's all set."]},
  {id:143, unit:"3.1", es:"Estoy trabajando en eso", en:"I'm working on it.", acceptable:["I'm on it."]},
  {id:144, unit:"3.1", es:"Dame un momento", en:"Give me a moment.", acceptable:["Give me a second."]},
  {id:145, unit:"3.1", es:"Gracias por la paciencia", en:"Thanks for your patience.", acceptable:["Thank you for your patience."]},

  // 3.2
  {id:146, unit:"3.2", es:"No hay problema", en:"No problem.", acceptable:["No worries."]},
  {id:147, unit:"3.2", es:"S√≠ hay problema", en:"There is a problem.", acceptable:["There's a problem."]},
  {id:148, unit:"3.2", es:"Necesito arreglar esto", en:"I need to fix this.", acceptable:["I need to get this fixed."]},
  {id:149, unit:"3.2", es:"No es correcto", en:"It's not correct.", acceptable:["That's not correct."]},
  {id:150, unit:"3.2", es:"Es correcto", en:"It's correct.", acceptable:["That's correct."]},
  {id:151, unit:"3.2", es:"Est√° roto", en:"It's broken.", acceptable:["It's not working."]},
  {id:152, unit:"3.2", es:"No est√° listo", en:"It's not ready.", acceptable:["It's not ready yet."]},
  {id:153, unit:"3.2", es:"Est√° tarde", en:"It's late.", acceptable:["It's running late."]},
  {id:154, unit:"3.2", es:"Est√° temprano", en:"It's early.", acceptable:[]},
  {id:155, unit:"3.2", es:"Se perdi√≥", en:"It got lost.", acceptable:["It's lost."]},
  {id:156, unit:"3.2", es:"Lo encontr√©", en:"I found it.", acceptable:["I found it already."]},
  {id:157, unit:"3.2", es:"No es m√≠o", en:"It's not mine.", acceptable:["That's not mine."]},
  {id:158, unit:"3.2", es:"Es m√≠o", en:"It's mine.", acceptable:["That's mine."]},
  {id:159, unit:"3.2", es:"Es tuyo", en:"It's yours.", acceptable:["That's yours."]},
  {id:160, unit:"3.2", es:"Est√° vac√≠o", en:"It's empty.", acceptable:[]},
  {id:161, unit:"3.2", es:"Est√° lleno", en:"It's full.", acceptable:[]},
  {id:162, unit:"3.2", es:"Necesito reemplazo", en:"I need a replacement.", acceptable:["I need to replace this."]},
  {id:163, unit:"3.2", es:"Necesito un reembolso", en:"I need a refund.", acceptable:["Can I get a refund?"]},
  {id:164, unit:"3.2", es:"No estoy de acuerdo", en:"I don't agree.", acceptable:["I disagree."]},
  {id:165, unit:"3.2", es:"Estoy de acuerdo", en:"I agree.", acceptable:["I agree with you."]},
  {id:166, unit:"3.2", es:"No es justo", en:"It's not fair.", acceptable:["That's not fair."]},
  {id:167, unit:"3.2", es:"Es justo", en:"It's fair.", acceptable:["That's fair."]},
  {id:168, unit:"3.2", es:"Hablemos", en:"Let's talk.", acceptable:["Let's talk about it."]},
  {id:169, unit:"3.2", es:"Vamos a arreglarlo", en:"Let's fix it.", acceptable:["Let's sort it out."]},
  {id:170, unit:"3.2", es:"Gracias por entender", en:"Thanks for understanding.", acceptable:["Thank you for understanding."]},

  // 4.1
  {id:171, unit:"4.1", es:"Claro", en:"Sure.", acceptable:["Of course."]},
  {id:172, unit:"4.1", es:"Tal vez", en:"Maybe.", acceptable:[]},
  {id:173, unit:"4.1", es:"No realmente", en:"Not really.", acceptable:["Not really, no."]},
  {id:174, unit:"4.1", es:"Supongo", en:"I guess.", acceptable:["I suppose."]},
  {id:175, unit:"4.1", es:"Dame un segundo", en:"Give me a second.", acceptable:["Give me a moment."]},
  {id:176, unit:"4.1", es:"Tiene sentido", en:"That makes sense.", acceptable:["Makes sense."]},
  {id:177, unit:"4.1", es:"No importa", en:"It doesn't matter.", acceptable:["Doesn't matter."]},
  {id:178, unit:"4.1", es:"Est√° bien", en:"That's fine.", acceptable:["That's okay."]},
  {id:179, unit:"4.1", es:"Depende", en:"It depends.", acceptable:["Depends."]},
  {id:180, unit:"4.1", es:"As√≠ es", en:"That's right.", acceptable:["You're right."]},
  {id:181, unit:"4.1", es:"Exacto", en:"Exactly.", acceptable:[]},
  {id:182, unit:"4.1", es:"M√°s o menos", en:"Kind of.", acceptable:["Sort of."]},
  {id:183, unit:"4.1", es:"Casi", en:"Almost.", acceptable:[]},
  {id:184, unit:"4.1", es:"No estoy seguro", en:"I'm not sure.", acceptable:["Not sure."]},
  {id:185, unit:"4.1", es:"D√©jame pensar", en:"Let me think.", acceptable:["Let me see."]},
  {id:186, unit:"4.1", es:"En serio", en:"Seriously.", acceptable:["For real?"]},
  {id:187, unit:"4.1", es:"Sin problema", en:"No worries.", acceptable:["No problem."]},
  {id:188, unit:"4.1", es:"Est√° bien para m√≠", en:"It's okay with me.", acceptable:["Works for me."]},
  {id:189, unit:"4.1", es:"De acuerdo", en:"Alright.", acceptable:["Okay."]},
  {id:190, unit:"4.1", es:"Como quieras", en:"Up to you.", acceptable:["Whatever you want."]},

  // 4.2
  {id:191, unit:"4.2", es:"Voy a ir", en:"I'm gonna go.", acceptable:["I'm going to go."]},
  {id:192, unit:"4.2", es:"Quiero hacer", en:"I wanna do it.", acceptable:["I want to do it."]},
  {id:193, unit:"4.2", es:"M√°s o menos", en:"Kinda.", acceptable:["Kind of."]},
  {id:194, unit:"4.2", es:"Un poco", en:"A little bit.", acceptable:["A bit."]},
  {id:195, unit:"4.2", es:"Ahora mismo", en:"Right now.", acceptable:["Just now."]},
  {id:196, unit:"4.2", es:"En este momento", en:"At the moment.", acceptable:["Right now."]},
  {id:197, unit:"4.2", es:"Estoy ocupado ahora", en:"I'm busy right now.", acceptable:["I'm busy at the moment."]},
  {id:198, unit:"4.2", es:"Te aviso luego", en:"I'll let you know later.", acceptable:["I'll let you know."]},
  {id:199, unit:"4.2", es:"Estoy de camino", en:"I'm on my way.", acceptable:["On my way."]},
  {id:200, unit:"4.2", es:"Ya casi", en:"Almost there.", acceptable:["I'm almost there."]},
  {id:201, unit:"4.2", es:"Dame chance", en:"Give me a chance.", acceptable:["Give me a minute."]},
  {id:202, unit:"4.2", es:"No pasa nada", en:"It's all good.", acceptable:["No big deal."]},
  {id:203, unit:"4.2", es:"Me equivoqu√©", en:"I messed up.", acceptable:["I made a mistake."]},
  {id:204, unit:"4.2", es:"Fue mi culpa", en:"It's my fault.", acceptable:["My fault."]},
  {id:205, unit:"4.2", es:"Todo bien", en:"All good.", acceptable:["Everything's good."]},
  {id:206, unit:"4.2", es:"Estoy bien", en:"I'm good.", acceptable:["I'm fine."]},
  {id:207, unit:"4.2", es:"No estoy bien", en:"I'm not okay.", acceptable:["I'm not doing well."]},
  {id:208, unit:"4.2", es:"Estoy cansado", en:"I'm worn out.", acceptable:["I'm exhausted."]},
  {id:209, unit:"4.2", es:"Necesito descanso", en:"I need a break.", acceptable:["I need some rest."]},
  {id:210, unit:"4.2", es:"Hablamos luego", en:"We'll talk later.", acceptable:["Talk to you later."]},
];

/* =========================
   Tutores / Voz
   ========================= */
const tutors = [
  {name:"Ana", emoji:"üë©‚Äçüè´", esLang:"es-ES", enLang:"en-US", pitchES:1.05, rateES:0.97, pitchEN:1.05, rateEN:0.92,
   style:"Corrijo en espa√±ol: qu√© falt√≥ + c√≥mo suena natural."},
  {name:"Mike", emoji:"üë®‚Äçüè´", esLang:"es-ES", enLang:"en-US", pitchES:0.98, rateES:0.95, pitchEN:0.92, rateEN:0.92,
   style:"Pronunciaci√≥n USA: escucha y copia la estructura."},
  {name:"Alex", emoji:"üßë‚Äçüè´", esLang:"es-ES", enLang:"en-US", pitchES:1.00, rateES:0.98, pitchEN:1.00, rateEN:0.98,
   style:"Fluidez: r√°pido y natural (sin drama)." },
];

/* =========================
   Estado / Persistencia
   ========================= */
const KEY = "englishTutorCourse_v3";
let state = loadState() || {
  tutorIndex: 0,
  route: "ALL",
  exerciseMode: "TRANSLATE", // TRANSLATE | DICTATION | SPEAK
  idxInRoute: 0,
  xp: 0,
  streak: 0,
  completed: {}, // lessonId:true
  lastWasCorrect: false,
  hintShown: false,
};

let chosenTokens = [];
let routeIndices = [];

function saveState(){ localStorage.setItem(KEY, JSON.stringify(state)); }
function loadState(){
  try { return JSON.parse(localStorage.getItem(KEY)); } catch { return null; }
}

function stopAllAudio(){
  stopVoice();
  stopVoiceInput();
}

function resetProgress(){
  stopAllAudio();
  localStorage.removeItem(KEY);
  state = {tutorIndex:0, route:"ALL", exerciseMode:"TRANSLATE", idxInRoute:0, xp:0, streak:0, completed:{}, lastWasCorrect:false, hintShown:false};
  chosenTokens = [];
  computeRoute();
  renderUnits();
  renderLesson();
}

const $ = (id)=>document.getElementById(id);
const norm = (s)=> (s||"")
  .toLowerCase()
  .trim()
  .replace(/[‚Äô]/g,"'")
  .replace(/[‚Äú‚Äù]/g,'"')
  .replace(/\s+/g," ");

function speak(text, lang, pitch=1.0, rate=1.0){
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang; u.pitch = pitch; u.rate = rate;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}
function stopVoice(){ speechSynthesis.cancel(); }

function tokensFromEnglish(en){
  return (en||"").replace(/\s+/g," ").trim().split(" ").map(x=>x.trim()).filter(Boolean);
}

function levelFromXP(xp){ return 1 + Math.floor(xp / 60); }

function computeRoute(){
  routeIndices = [];
  for(let i=0;i<LESSONS.length;i++){
    const u = LESSONS[i].unit;
    const r = routeOfUnit(u);
    if(state.route==="ALL" || r===state.route) routeIndices.push(i);
  }
  if(state.idxInRoute < 0) state.idxInRoute = 0;
  if(state.idxInRoute >= routeIndices.length) state.idxInRoute = Math.max(0, routeIndices.length-1);
}

function routeProgressPct(){
  if(routeIndices.length===0) return 0;
  let done=0;
  for(const i of routeIndices){
    const id = LESSONS[i].id;
    if(state.completed[id]) done++;
  }
  return Math.round((done / routeIndices.length) * 100);
}

/* =========================
   Rutas UI
   ========================= */
function setRoute(route){
  state.route = route;
  state.idxInRoute = 0;
  state.lastWasCorrect = false;
  state.hintShown = false;
  chosenTokens = [];
  computeRoute();
  saveState();

  ["rAll","rSurv","rWork","rNat"].forEach(id=>$(id).classList.remove("active"));
  if(route==="ALL") $("rAll").classList.add("active");
  if(route==="SURVIVAL") $("rSurv").classList.add("active");
  if(route==="WORK") $("rWork").classList.add("active");
  if(route==="NATURAL") $("rNat").classList.add("active");

  renderUnits();
  renderLesson();
}

/* =========================
   Unidades Sidebar
   ========================= */
function renderUnits(){
  const root = $("units");
  root.innerHTML = "";

  const pct = routeProgressPct();
  $("pct").innerText = `${pct}%`;
  $("fill").style.width = `${pct}%`;

  UNITS.forEach(u=>{
    const unitRoute = routeOfUnit(u.id);
    const allowed = (state.route==="ALL" || unitRoute===state.route);

    const lessonsInUnit = LESSONS.filter(L=>L.unit===u.id);
    const doneInUnit = lessonsInUnit.filter(L=>state.completed[L.id]).length;

    const box = document.createElement("div");
    box.className = "unit";
    box.innerHTML = `
      <p class="unitTitle">${u.name} ${allowed ? "" : " (fuera de ruta)"}</p>
      <p class="unitDesc">${u.desc}</p>
      <div class="small" style="margin-top:6px">Progreso: ${doneInUnit}/${lessonsInUnit.length}</div>
      <div class="unitBtnRow">
        <button class="tinyBtn" type="button" ${allowed ? "" : "disabled"}>${allowed ? "Ir a unidad" : "Bloqueada"}</button>
        <span class="chip">${u.id}</span>
      </div>
    `;
    box.querySelector("button").onclick = ()=>{
      if(!allowed) return;
      const firstGlobal = LESSONS.findIndex(L=>L.unit===u.id);
      const inRoutePos = routeIndices.findIndex(x=>x===firstGlobal);
      if(inRoutePos>=0){
        state.idxInRoute = inRoutePos;
        state.lastWasCorrect = false;
        state.hintShown = false;
        chosenTokens = [];
        saveState();
        renderLesson();
      }
    };
    root.appendChild(box);
  });
}

function jumpToFirstIncomplete(){
  const first = routeIndices.findIndex(i=>!state.completed[LESSONS[i].id]);
  state.idxInRoute = first>=0 ? first : Math.max(0, routeIndices.length-1);
  state.lastWasCorrect = false;
  state.hintShown = false;
  chosenTokens = [];
  saveState();
  renderLesson();
}

/* =========================
   Tutores
   ========================= */
function setTutor(n){
  state.tutorIndex = n;
  ["t0","t1","t2"].forEach((id,i)=>$(id).classList.toggle("active", i===n));
  saveState();
  renderLesson();
}

/* =========================
   Modos
   ========================= */
function setExerciseMode(mode){
  state.exerciseMode = mode;
  saveState();
  $("mTranslate").classList.toggle("active", mode==="TRANSLATE");
  $("mDictation").classList.toggle("active", mode==="DICTATION");
  $("mSpeak").classList.toggle("active", mode==="SPEAK");
  renderLesson();
}

/* =========================
   Lecci√≥n
   ========================= */
function currentLesson(){
  const globalIdx = routeIndices[state.idxInRoute] ?? 0;
  return LESSONS[globalIdx];
}

function renderLesson(){
  // ruta active
  ["rAll","rSurv","rWork","rNat"].forEach(id=>$(id).classList.remove("active"));
  if(state.route==="ALL") $("rAll").classList.add("active");
  if(state.route==="SURVIVAL") $("rSurv").classList.add("active");
  if(state.route==="WORK") $("rWork").classList.add("active");
  if(state.route==="NATURAL") $("rNat").classList.add("active");

  // modo active
  $("mTranslate").classList.toggle("active", state.exerciseMode==="TRANSLATE");
  $("mDictation").classList.toggle("active", state.exerciseMode==="DICTATION");
  $("mSpeak").classList.toggle("active", state.exerciseMode==="SPEAK");

  const L = currentLesson();
  const T = tutors[state.tutorIndex];

  // Stats
  $("statLesson").innerText = `${L.id}/${LESSONS.length}`;
  $("statUnit").innerText = `Unidad ${L.unit}`;
  $("statXP").innerText = state.xp;
  $("statLevel").innerText = `Nivel ${levelFromXP(state.xp)}`;
  $("statStreak").innerText = state.streak;

  // Meta
  $("lessonMeta").innerText = `Ruta ${state.route} ¬∑ Unidad ${L.unit} ¬∑ Lecci√≥n ${L.id}`;
  $("lessonTitle").innerText = `${L.es}`;
  $("lessonSub").innerText = `${T.emoji} Tutor ${T.name}: ${T.style}`;

  // Prompt por modo
  if(state.exerciseMode==="TRANSLATE"){
    $("scene").innerText = "Traduce al ingl√©s (vida real). Responde escribiendo o con Word Bank.";
    $("promptLabel").innerText = "Tutor pregunta (ES):";
    $("esText").innerText = `¬øC√≥mo se dice en ingl√©s?: ‚Äú${L.es}‚Äù`;
    $("typedTip").innerText = "Primero intenta sin ayuda. Si fallas, usa pista o Word Bank.";
  } else if(state.exerciseMode==="DICTATION"){
    $("scene").innerText = "DICTADO: escucha el ingl√©s y escr√≠belo exactamente (entrenas el o√≠do).";
    $("promptLabel").innerText = "Tutor (EN) ‚Äî dictado:";
    $("esText").innerText = `Escucha: toca ‚Äúüîä Ingl√©s (EN)‚Äù y escribe lo que oyes.`;
    $("typedTip").innerText = "Tip: escucha 2 veces. Si fallas, usa Word Bank para reconstruir y luego escribe.";
  } else {
    $("scene").innerText = "PRONUNCIACI√ìN: habla en ingl√©s y te eval√∫o (claridad + palabras correctas).";
    $("promptLabel").innerText = "Di en voz alta (EN):";
    $("esText").innerText = `Frase objetivo: ‚Äú${L.en}‚Äù`;
    $("typedTip").innerText = "Pulsa üé§ y habla. Objetivo: 90%+ accuracy.";
  }

  // Variantes
  const variants = (L.acceptable||[]).filter(Boolean);
  $("variants").innerText = variants.length ? `‚úÖ Tambi√©n se acepta: ${variants.slice(0,3).join(" ¬∑ ")}` : "";

  // Hint
  $("hint").innerText = state.hintShown ? buildHint(L) : "üí° Pista oculta (toca ‚ÄúPista‚Äù)";

  // Inputs
  $("typed").value = "";
  chosenTokens = [];
  renderWordBank(L);

  // Feedback
  $("fb").className = "feedback";
  $("fb").innerText = "";
  $("micStatus").innerText = "";

  // Next lock
  const mustBeCorrect = !state.lastWasCorrect;
  $("nextLockChip").innerText = mustBeCorrect ? "üîí Debes acertar para pasar" : "‚úÖ Puedes pasar";
  $("nextBtn").disabled = mustBeCorrect;
  $("nextBtn").classList.toggle("lock", mustBeCorrect);

  // tutor buttons
  ["t0","t1","t2"].forEach((id,i)=>$(id).classList.toggle("active", i===state.tutorIndex));

  renderUnits();
}

function renderWordBank(L){
  const bank = $("bank");
  bank.innerHTML = "";
  const toks = tokensFromEnglish(L.en);
  const shuffled = toks.slice().sort(()=>Math.random()-0.5);
  shuffled.forEach(tok=>{
    const b = document.createElement("button");
    b.type = "button";
    b.className = "tok";
    b.innerText = tok;
    b.onclick = ()=>{
      chosenTokens.push(tok);
      $("builtText").innerText = chosenTokens.join(" ");
      b.disabled = true;
    };
    bank.appendChild(b);
  });
  $("builtText").innerText = "";
}

function resetWordBank(){
  chosenTokens = [];
  renderWordBank(currentLesson());
}

function copyBuiltToInput(){
  const built = chosenTokens.join(" ").trim();
  if(built) $("typed").value = built;
}

/* =========================
   Voz / Pistas
   ========================= */
function speakQuestion(){
  const L = currentLesson();
  const T = tutors[state.tutorIndex];
  if(state.exerciseMode==="TRANSLATE"){
    speak(`¬øC√≥mo se dice "${L.es}" en ingl√©s?`, T.esLang, T.pitchES, T.rateES);
  } else if (state.exerciseMode==="DICTATION"){
    speak("Dictado. Escucha y escribe.", T.esLang, T.pitchES, T.rateES);
  } else {
    speak("Pronunciaci√≥n. Di la frase en ingl√©s.", T.esLang, T.pitchES, T.rateES);
  }
}

function speakAnswer(){
  const L = currentLesson();
  const T = tutors[state.tutorIndex];
  speak(L.en, T.enLang, T.pitchEN, T.rateEN);
}

function buildHint(L){
  const toks = tokensFromEnglish(L.en);
  const start = toks[0] || "";
  const end = toks[toks.length-1] || "";
  return `üí° Empieza con ‚Äú${start}‚Äù y termina con ‚Äú${end}‚Äù.`;
}

function showHint(){
  state.hintShown = true;
  saveState();
  const L = currentLesson();
  $("hint").innerText = buildHint(L);
  const T = tutors[state.tutorIndex];
  speak("Pista. " + buildHint(L).replace("üí°",""), T.esLang, T.pitchES, T.rateES);
}

/* =========================
   Correcci√≥n (FIXES: normalizaci√≥n + respuestas libres)
   ========================= */
function acceptableAnswers(L){
  const arr = [L.en].concat(L.acceptable || []);
  return arr
    .map(x => norm(x).replace(/[.?!]+$/,"").replace(/‚Ä¶/g,"").trim())
    .filter(Boolean);
}

function normalizeUser(s){
  return norm(s).replace(/[.?!]+$/,"").replace(/‚Ä¶/g,"").trim();
}

function passLesson(L, T, gain){
  state.xp += gain;
  state.streak += 1;
  state.completed[L.id] = true;
  state.lastWasCorrect = true;
  state.hintShown = false;
  saveState();

  $("fb").className = "feedback ok";
  $("fb").innerText = `‚úÖ Correcto. (+${gain} XP)`;
  speak("Correcto. Muy bien.", T.esLang, T.pitchES, T.rateES);

  $("nextLockChip").innerText = "‚úÖ Puedes pasar";
  $("nextBtn").disabled = false;
  $("nextBtn").classList.remove("lock");

  $("statXP").innerText = state.xp;
  $("statStreak").innerText = state.streak;
  $("statLevel").innerText = `Nivel ${levelFromXP(state.xp)}`;
  renderUnits();
}

function check(){
  const L = currentLesson();
  const T = tutors[state.tutorIndex];

  const typed = $("typed").value.trim();
  const built = chosenTokens.join(" ").trim();
  const attempt = typed || built;

  if(!attempt){
    fail("Responde escribiendo, armando la frase con palabras o usando üé§.");
    speak("Responde primero.", T.esLang, T.pitchES, T.rateES);
    return;
  }

  const user = normalizeUser(attempt);
  const okSet = acceptableAnswers(L);

  // ‚úÖ Respuestas libres (nombre/pa√≠s): solo necesita empezar con la base
  if (L.free){
    const base = norm(L.en).trim();
    const okPrefix = user.startsWith(base);
    const alsoOk = (L.acceptable || []).some(a => user.startsWith(norm(a).trim()));
    if(okPrefix || alsoOk){
      const gain = state.hintShown ? 8 : 12;
      passLesson(L, T, gain);
      return;
    }
  }

  if(okSet.includes(user)){
    const gain = state.hintShown ? 8 : 12;
    passLesson(L, T, gain);
    return;
  }

  // Incorrecto
  state.streak = 0;
  state.lastWasCorrect = false;
  state.hintShown = true;
  saveState();

  const tip = coachTip(user, okSet[0] || normalizeUser(L.en));
  $("fb").className = "feedback bad";
  $("fb").innerHTML = `‚ùå Te entend√≠, pero no est√° correcto.<br><br>
    ‚úÖ Respuesta (una correcta): <b>${L.en}</b><br>
    üßë‚Äçüè´ Tutor: ${tip}
  `;
  speak("No. Int√©ntalo otra vez.", T.esLang, T.pitchES, T.rateES);

  $("hint").innerText = buildHint(L);
  $("nextLockChip").innerText = "üîí Debes acertar para pasar";
  $("nextBtn").disabled = true;
  $("nextBtn").classList.add("lock");

  $("statStreak").innerText = state.streak;
}

function fail(msg){
  $("fb").className = "feedback bad";
  $("fb").innerText = `‚ùå ${msg}`;
  state.streak = 0;
  state.lastWasCorrect = false;
  saveState();
  $("statStreak").innerText = state.streak;
  $("nextBtn").disabled = true;
  $("nextBtn").classList.add("lock");
  $("nextLockChip").innerText = "üîí Debes acertar para pasar";
}

function coachTip(user, correct){
  const uToks = user.replace(/[?.!]/g,"").split(" ").filter(Boolean);
  const cToks = normalizeUser(correct).replace(/[?.!]/g,"").split(" ").filter(Boolean);

  const missing = cToks.filter(w => !uToks.includes(w));
  const extra = uToks.filter(w => !cToks.includes(w));

  if(correct.includes("don't") && user.includes("no ")) return "En ingl√©s no se usa ‚Äúno‚Äù as√≠. Usa **don't** (do not).";
  if(correct.includes("can't") && user.includes("no ")) return "En ingl√©s no se usa ‚Äúno‚Äù as√≠. Usa **can't** (cannot).";
  if(correct.includes("what's") && user.includes("whats")) return "Pon ap√≥strofe: **what's** (what is).";
  if(correct.toLowerCase().includes("i'm") && user.includes("im ")) return "Pon ap√≥strofe: **I'm** (I am).";

  if(missing.length) return `Te faltan palabras: <b>${missing.slice(0,6).join(", ")}</b>.`;
  if(extra.length) return `Tienes palabras de m√°s: <b>${extra.slice(0,6).join(", ")}</b>.`;

  const sameSet = cToks.every(w=>uToks.includes(w)) && uToks.every(w=>cToks.includes(w));
  if(sameSet && user !== normalizeUser(correct)){
    return "Tienes las palabras, pero el **orden** est√° mal. Usa el Word Bank para acomodarlo y luego escribe.";
  }

  if(state.exerciseMode==="DICTATION"){
    return "En dictado, escucha otra vez (üîä). F√≠jate en contracciones (I'm, don't) y palabras cortas (a, the).";
  }
  if(state.exerciseMode==="SPEAK"){
    return "En pronunciaci√≥n: habla m√°s lento, marca contracciones (I'm / don't) y vuelve a intentar con üé§.";
  }

  return "Casi. Escucha el ingl√©s (üîä) y copia la estructura exacta.";
}

/* =========================
   Pronunciaci√≥n (üé§)
   - Web Speech API (SpeechRecognition)
   - Eval√∫a con similarity + palabras faltantes/de m√°s
   ========================= */
let recognition = null;

function speechSupported(){
  return !!(window.SpeechRecognition || window.webkitSpeechRecognition);
}

function stopVoiceInput(){
  try { if(recognition) recognition.stop(); } catch {}
  $("micStatus").innerText = "";
}

function levenshtein(a,b){
  a=a||""; b=b||"";
  const m=a.length, n=b.length;
  const dp = Array.from({length:m+1}, ()=>Array(n+1).fill(0));
  for(let i=0;i<=m;i++) dp[i][0]=i;
  for(let j=0;j<=n;j++) dp[0][j]=j;
  for(let i=1;i<=m;i++){
    for(let j=1;j<=n;j++){
      const cost = a[i-1]===b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(
        dp[i-1][j]+1,
        dp[i][j-1]+1,
        dp[i-1][j-1]+cost
      );
    }
  }
  return dp[m][n];
}

function similarityPct(a,b){
  a = normalizeUser(a); b = normalizeUser(b);
  if(!a && !b) return 100;
  const maxLen = Math.max(a.length,b.length) || 1;
  const dist = levenshtein(a,b);
  const sim = Math.max(0, 1 - dist/maxLen);
  return Math.round(sim*100);
}

function wordDiff(user, target){
  const u = normalizeUser(user).split(" ").filter(Boolean);
  const t = normalizeUser(target).split(" ").filter(Boolean);
  const missing = t.filter(w => !u.includes(w));
  const extra = u.filter(w => !t.includes(w));
  return {missing, extra};
}

function bestTargetFor(L, userText){
  const candidates = [L.en].concat(L.acceptable||[]).filter(Boolean);
  let best = {target: L.en, score: -1};
  for(const c of candidates){
    const sc = similarityPct(userText, c);
    if(sc > best.score) best = {target: c, score: sc};
  }
  return best;
}

function startSpeakPractice(){
  const L = currentLesson();
  const T = tutors[state.tutorIndex];

  if(!speechSupported()){
    $("fb").className = "feedback bad";
    $("fb").innerText = "‚ùå Tu navegador no soporta reconocimiento de voz. Usa iPhone Safari/Chrome moderno y permite micr√≥fono.";
    return;
  }

  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  recognition = new SR();
  recognition.lang = "en-US";
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  $("micStatus").innerText = "üé§ Escuchando... habla ahora (EN).";
  speak("Speak now.", T.enLang, 1.0, 1.0);

  recognition.onresult = (e)=>{
    const text = (e.results?.[0]?.[0]?.transcript || "").trim();
    const conf = e.results?.[0]?.[0]?.confidence;
    $("micStatus").innerText = `üìù Te escuch√©: "${text}"${(typeof conf==="number") ? ` (conf ${Math.round(conf*100)}%)` : ""}`;

    // ponerlo en el input para que el alumno vea lo que dijo
    $("typed").value = text;

    // evaluar vs mejor target (base o variante)
    const best = bestTargetFor(L, text);
    const {missing, extra} = wordDiff(text, best.target);

    // puntuaci√≥n
    const score = best.score;
    const pass = (score >= 90) || (L.free && normalizeUser(text).startsWith(norm(L.en)));

    if(pass){
      // premio menor en SPEAK para no farmear XP
      const gain = state.hintShown ? 6 : 9;
      passLesson(L, T, gain);
      $("fb").innerHTML = `‚úÖ Pronunciaci√≥n OK (${score}%).<br>üéØ Objetivo: <b>${best.target}</b>`;
      return;
    }

    // fallo: feedback duro-humano
    state.streak = 0;
    state.lastWasCorrect = false;
    state.hintShown = true;
    saveState();
    $("statStreak").innerText = state.streak;

    $("fb").className = "feedback bad";
    $("fb").innerHTML =
      `‚ùå Pronunciaci√≥n/estructura no llega (${score}%).<br><br>
       üéØ Objetivo: <b>${best.target}</b><br>
       üß© Faltan: <b>${missing.slice(0,8).join(", ") || "‚Äî"}</b><br>
       ‚ûï Sobran: <b>${extra.slice(0,8).join(", ") || "‚Äî"}</b><br>
       üí° Tip: escucha ‚Äúüîä Ingl√©s (EN)‚Äù y repite marcando contracciones (I'm / don't).`;

    $("hint").innerText = buildHint(L);
    $("nextLockChip").innerText = "üîí Debes acertar para pasar";
    $("nextBtn").disabled = true;
    $("nextBtn").classList.add("lock");
  };

  recognition.onerror = (e)=>{
    $("micStatus").innerText = "";
    $("fb").className = "feedback bad";
    $("fb").innerText = `‚ùå Error micr√≥fono: ${e.error}. Revisa permisos de micr√≥fono y vuelve a intentar.`;
  };

  recognition.onend = ()=>{
    // si termin√≥ solo
    if($("micStatus").innerText.includes("Escuchando")){
      $("micStatus").innerText = "‚èπÔ∏è Micr√≥fono detenido.";
    }
  };

  try { recognition.start(); } catch {}
}

/* =========================
   Navegaci√≥n
   ========================= */
function next(){
  if(!state.lastWasCorrect){
    $("fb").className = "feedback bad";
    $("fb").innerText = "üîí No puedes pasar todav√≠a. Primero acierta una vez.";
    return;
  }
  stopAllAudio();
  state.idxInRoute = Math.min(state.idxInRoute + 1, routeIndices.length - 1);
  state.lastWasCorrect = false;
  state.hintShown = false;
  chosenTokens = [];
  saveState();
  renderLesson();
}

/* =========================
   Init
   ========================= */
computeRoute();
renderUnits();
renderLesson();
</script>
</body>
</html>
